<!-- miniprogram/pages/report-native/report-native.wxml -->
<view class="report-container">
  <!-- åŠ è½½ä¸­ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½æŠ¥å‘Šä¸­...</text>
  </view>

  <!-- é”™è¯¯æç¤º -->
  <view wx:elif="{{error}}" class="error-container">
    <text class="error-icon">âš ï¸</text>
    <text class="error-text">{{error}}</text>
    <button class="retry-button" bindtap="loadReportData">é‡è¯•</button>
  </view>

  <!-- æŠ¥å‘Šå†…å®¹ -->
  <view wx:else class="report-content">
    <!-- å¤´éƒ¨ -->
    <view class="report-header">
      <text class="report-title">ä¸ªäººå¾ä¿¡åˆ†ææŠ¥å‘Š</text>
      <text class="report-subtitle">{{personalInfo.name}} | æŠ¥å‘Šç¼–å·: {{reportId}}</text>
    </view>

    <!-- ä¸ªäººä¿¡æ¯å¡ç‰‡ -->
    <view class="section personal-section">
      <view class="section-title">
        <text class="title-icon">ğŸ‘¤</text>
        <text class="title-text">ä¸ªäººä¿¡æ¯</text>
      </view>
      <view class="info-grid">
        <view class="info-item">
          <text class="info-label">å§“å</text>
          <text class="info-value">{{personalInfo.name}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">å¹´é¾„</text>
          <text class="info-value">{{personalInfo.age}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">å©šå§»çŠ¶å†µ</text>
          <text class="info-value">{{personalInfo.marital_status}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">èº«ä»½è¯å·</text>
          <text class="info-value">{{personalInfo.id_card}}</text>
        </view>
      </view>
    </view>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-grid">
      <view class="stat-card">
        <view class="stat-icon icon-credit">ğŸ’°</view>
        <text class="stat-label">æ€»æˆä¿¡é¢åº¦</text>
        <text class="stat-value">{{stats.total_credit}}<text class="stat-unit">å…ƒ</text></text>
      </view>
      <view class="stat-card">
        <view class="stat-icon icon-debt">ğŸ“Š</view>
        <text class="stat-label">æ€»è´Ÿå€ºé‡‘é¢</text>
        <text class="stat-value">{{stats.total_debt}}<text class="stat-unit">å…ƒ</text></text>
      </view>
      <view class="stat-card">
        <view class="stat-icon icon-institution">ğŸ¦</view>
        <text class="stat-label">æ€»æœºæ„æ•°</text>
        <text class="stat-value">{{stats.total_institutions}}<text class="stat-unit">ä¸ª</text></text>
      </view>
      <view class="stat-card">
        <view class="stat-icon icon-loan">ğŸ¢</view>
        <text class="stat-label">è´·æ¬¾æœºæ„æ•°</text>
        <text class="stat-value">{{stats.loan_institutions}}<text class="stat-unit">ä¸ª</text></text>
      </view>
      <view class="stat-card">
        <view class="stat-icon icon-overdue">âš ï¸</view>
        <text class="stat-label">å†å²é€¾æœŸæœˆä»½</text>
        <text class="stat-value">{{stats.overdue_months}}<text class="stat-unit">æœˆ</text></text>
      </view>
      <view class="stat-card">
        <view class="stat-icon icon-query">ğŸ”</view>
        <text class="stat-label">è¿‘3æœˆæŸ¥è¯¢æ¬¡æ•°</text>
        <text class="stat-value">{{stats.query_count_3m}}<text class="stat-unit">æ¬¡</text></text>
      </view>
    </view>

    <!-- è´Ÿå€ºæ„æˆ -->
    <view class="section">
      <view class="section-title">
        <text class="title-icon">ğŸ“ˆ</text>
        <text class="title-text">è´Ÿå€ºæ„æˆåˆ†æ</text>
      </view>
      <view class="debt-list">
        <view wx:for="{{debtComposition}}" wx:key="type" class="debt-item">
          <view class="debt-header">
            <text class="debt-type">{{item.type}}</text>
            <text class="debt-usage" wx:if="{{item.usage_rate}}">ä½¿ç”¨ç‡: {{item.usage_rate}}</text>
          </view>
          <view class="debt-stats">
            <view class="debt-stat">
              <text class="debt-stat-label">æœºæ„æ•°</text>
              <text class="debt-stat-value">{{item.institutions}}ä¸ª</text>
            </view>
            <view class="debt-stat">
              <text class="debt-stat-label">è´¦æˆ·æ•°</text>
              <text class="debt-stat-value">{{item.accounts}}ä¸ª</text>
            </view>
            <view class="debt-stat">
              <text class="debt-stat-label">æˆä¿¡é¢åº¦</text>
              <text class="debt-stat-value">{{item.credit_limit}}å…ƒ</text>
            </view>
            <view class="debt-stat">
              <text class="debt-stat-label">ä½™é¢</text>
              <text class="debt-stat-value">{{item.balance}}å…ƒ</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- è´·æ¬¾è¯¦æƒ… -->
    <view class="section">
      <view class="section-title">
        <text class="title-icon">ğŸ¦</text>
        <text class="title-text">è´·æ¬¾è¯¦æƒ…</text>
      </view>
      
      <!-- è´·æ¬¾æ±‡æ€» -->
      <view class="loan-summary">
        <view class="summary-item">
          <text class="summary-label">å¹³å‡æœŸé™</text>
          <text class="summary-value">{{loanSummary.avg_period}}</text>
        </view>
        <view class="summary-item">
          <text class="summary-label">æœ€é«˜å•ç¬”</text>
          <text class="summary-value">{{loanSummary.max_balance}}å…ƒ</text>
        </view>
        <view class="summary-item">
          <text class="summary-label">æœ€å°å•ç¬”</text>
          <text class="summary-value">{{loanSummary.min_balance}}å…ƒ</text>
        </view>
        <view class="summary-item full-width">
          <text class="summary-label">æœºæ„ç±»å‹</text>
          <text class="summary-value">{{loanSummary.institution_types}}</text>
        </view>
      </view>

      <!-- é“¶è¡Œè´·æ¬¾ -->
      <view wx:if="{{bankLoans.length > 0}}" class="loan-category">
        <text class="category-title">é“¶è¡Œè´·æ¬¾</text>
        <view class="table-container">
          <scroll-view scroll-x="true" class="table-scroll">
            <view class="loan-table">
              <view class="table-header">
                <text class="table-cell">åºå·</text>
                <text class="table-cell">ç®¡ç†æœºæ„</text>
                <text class="table-cell">æˆä¿¡é¢åº¦</text>
                <text class="table-cell">ä½™é¢</text>
                <text class="table-cell">ä¸šåŠ¡ç±»å‹</text>
                <text class="table-cell">èµ·æ­¢æ—¥æœŸ</text>
                <text class="table-cell">å‰©ä½™æœŸé™</text>
                <text class="table-cell">ä½¿ç”¨ç‡</text>
              </view>
              <view wx:for="{{bankLoans}}" wx:key="id" class="table-row">
                <text class="table-cell">{{item.id}}</text>
                <text class="table-cell">{{item.institution}}</text>
                <text class="table-cell">{{item.credit_limit}}</text>
                <text class="table-cell">{{item.balance}}</text>
                <text class="table-cell">{{item.business_type}}</text>
                <text class="table-cell">{{item.period}}</text>
                <text class="table-cell">{{item.remaining_period}}</text>
                <text class="table-cell">{{item.usage_rate}}</text>
              </view>
            </view>
          </scroll-view>
        </view>
      </view>

      <!-- éé“¶æœºæ„è´·æ¬¾ -->
      <view wx:if="{{nonBankLoans.length > 0}}" class="loan-category">
        <text class="category-title">éé“¶æœºæ„è´·æ¬¾</text>
        <view class="table-container">
          <scroll-view scroll-x="true" class="table-scroll">
            <view class="loan-table">
              <view class="table-header">
                <text class="table-cell">åºå·</text>
                <text class="table-cell">ç®¡ç†æœºæ„</text>
                <text class="table-cell">æˆä¿¡é¢åº¦</text>
                <text class="table-cell">ä½™é¢</text>
                <text class="table-cell">ä¸šåŠ¡ç±»å‹</text>
                <text class="table-cell">èµ·æ­¢æ—¥æœŸ</text>
                <text class="table-cell">å‰©ä½™æœŸé™</text>
                <text class="table-cell">ä½¿ç”¨ç‡</text>
              </view>
              <view wx:for="{{nonBankLoans}}" wx:key="id" class="table-row">
                <text class="table-cell">{{item.id}}</text>
                <text class="table-cell">{{item.institution}}</text>
                <text class="table-cell">{{item.credit_limit}}</text>
                <text class="table-cell">{{item.balance}}</text>
                <text class="table-cell">{{item.business_type}}</text>
                <text class="table-cell">{{item.period}}</text>
                <text class="table-cell">{{item.remaining_period}}</text>
                <text class="table-cell">{{item.usage_rate}}</text>
              </view>
            </view>
          </scroll-view>
        </view>
      </view>
    </view>

    <!-- ä¿¡ç”¨å¡ä½¿ç”¨æƒ…å†µ -->
    <view class="section">
      <view class="section-title">
        <text class="title-icon">ğŸ’³</text>
        <text class="title-text">ä¿¡ç”¨å¡ä½¿ç”¨æƒ…å†µ</text>
      </view>
      
      <!-- ä½¿ç”¨ç‡åˆ†æ -->
      <view class="credit-usage-card">
        <view class="usage-header">
          <text class="usage-title">ä½¿ç”¨ç‡åˆ†æ</text>
          <text class="usage-percentage">{{creditUsage.usage_percentage}}%</text>
        </view>
        <view class="usage-progress">
          <view class="progress-bar" style="width: {{creditUsage.usage_percentage}}%;"></view>
        </view>
        <view class="usage-info">
          <view class="usage-item">
            <text class="usage-label">é£é™©ç­‰çº§</text>
            <text class="usage-value {{creditUsage.risk_level == 'ä½' ? 'risk-low' : (creditUsage.risk_level == 'ä¸­' ? 'risk-medium' : 'risk-high')}}">{{creditUsage.risk_level}}</text>
          </view>
          <view class="usage-item">
            <text class="usage-label">å½±å“ç¨‹åº¦</text>
            <text class="usage-value">{{creditUsage.impact_level}}</text>
          </view>
        </view>
        <view class="usage-amounts">
          <view class="amount-item">
            <text class="amount-label">æˆä¿¡é¢åº¦</text>
            <text class="amount-value">{{creditUsage.total_credit}}å…ƒ</text>
          </view>
          <view class="amount-item">
            <text class="amount-label">å·²ç”¨é¢åº¦</text>
            <text class="amount-value">{{creditUsage.used_credit}}å…ƒ</text>
          </view>
          <view class="amount-item">
            <text class="amount-label">å¯ç”¨é¢åº¦</text>
            <text class="amount-value">{{creditUsage.available_credit}}å…ƒ</text>
          </view>
        </view>
      </view>

      <!-- ä¿¡ç”¨å¡æ˜ç»† -->
      <view wx:if="{{creditCards.length > 0}}" class="credit-cards-list">
        <text class="list-title">ä¿¡ç”¨å¡æ˜ç»†</text>
        <view class="table-container">
          <scroll-view scroll-x="true" class="table-scroll">
            <view class="credit-table">
              <view class="table-header">
                <text class="table-cell">åºå·</text>
                <text class="table-cell">ç®¡ç†æœºæ„</text>
                <text class="table-cell">æˆä¿¡é¢åº¦</text>
                <text class="table-cell">å·²ç”¨é¢åº¦</text>
                <text class="table-cell">åˆ†æœŸä½™é¢</text>
                <text class="table-cell">ä½¿ç”¨ç‡</text>
                <text class="table-cell">å½“å‰çŠ¶æ€</text>
                <text class="table-cell">å†å²é€¾æœŸ</text>
              </view>
              <view wx:for="{{creditCards}}" wx:key="id" class="table-row">
                <text class="table-cell">{{item.id}}</text>
                <text class="table-cell">{{item.institution}}</text>
                <text class="table-cell">{{item.credit_limit}}</text>
                <text class="table-cell">{{item.used_amount}}</text>
                <text class="table-cell">{{item.installment_balance}}</text>
                <text class="table-cell">{{item.usage_rate}}</text>
                <text class="table-cell">{{item.status}}</text>
                <text class="table-cell">{{item.overdue_history}}</text>
              </view>
            </view>
          </scroll-view>
        </view>
      </view>
    </view>

    <!-- é€¾æœŸæƒ…å†µåˆ†æ -->
    <view class="section">
      <view class="section-title">
        <text class="title-icon">âš ï¸</text>
        <text class="title-text">é€¾æœŸæƒ…å†µåˆ†æ</text>
      </view>

      <view class="overdue-severity">
        <view class="severity-header">
          <text class="severity-title">ä¸¥é‡ç¨‹åº¦</text>
          <text class="severity-level">{{overdueAnalysis.severity_level}}</text>
        </view>
        <view class="severity-progress">
          <view class="severity-bar" style="width: {{overdueAnalysis.severity_percentage}}%;"></view>
        </view>
        <view class="overdue-stats">
          <view class="overdue-stat">
            <text class="overdue-stat-value">{{overdueAnalysis.overdue_90plus}}</text>
            <text class="overdue-stat-label">90å¤©ä»¥ä¸Š</text>
          </view>
          <view class="overdue-stat">
            <text class="overdue-stat-value">{{overdueAnalysis.overdue_30_90}}</text>
            <text class="overdue-stat-label">30-90å¤©</text>
          </view>
          <view class="overdue-stat">
            <text class="overdue-stat-value">{{overdueAnalysis.overdue_under_30}}</text>
            <text class="overdue-stat-label">30å¤©ä»¥å†…</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æŸ¥è¯¢è®°å½•åˆ†æ -->
    <view class="section">
      <view class="section-title">
        <text class="title-icon">ğŸ”</text>
        <text class="title-text">æŸ¥è¯¢è®°å½•åˆ†æ</text>
      </view>

      <view class="query-list">
        <view wx:for="{{queryRecords}}" wx:key="period" class="query-item">
          <view class="query-period">{{item.period}}</view>
          <view class="query-details">
            <view class="query-detail" wx:if="{{item.loan_approval > 0}}">
              <text class="query-label">è´·æ¬¾å®¡æ‰¹</text>
              <text class="query-value">{{item.loan_approval}}æ¬¡</text>
            </view>
            <view class="query-detail" wx:if="{{item.credit_card_approval > 0}}">
              <text class="query-label">ä¿¡ç”¨å¡å®¡æ‰¹</text>
              <text class="query-value">{{item.credit_card_approval}}æ¬¡</text>
            </view>
            <view class="query-detail" wx:if="{{item.guarantee_review > 0}}">
              <text class="query-label">æ‹…ä¿èµ„æ ¼å®¡æŸ¥</text>
              <text class="query-value">{{item.guarantee_review}}æ¬¡</text>
            </view>
            <view class="query-detail" wx:if="{{item.self_query > 0}}">
              <text class="query-label">æœ¬äººæŸ¥è¯¢</text>
              <text class="query-value">{{item.self_query}}æ¬¡</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- äº§å“æ¨è -->
    <view class="section" wx:if="{{productRecommendations.length > 0}}">
      <view class="section-title">
        <text class="title-icon">ğŸ¯</text>
        <text class="title-text">äº§å“æ¨è</text>
      </view>

      <view class="match-status">
        <text class="match-text">{{matchStatus}}</text>
      </view>

      <view class="product-list">
        <view wx:for="{{productRecommendations}}" wx:key="product_name" class="product-card">
          <view class="product-header">
            <text class="product-name">{{item.product_name}}</text>
            <text class="product-match">åŒ¹é…åº¦: {{item.match_score}}</text>
          </view>
          <view class="product-info">
            <view class="product-info-item">
              <text class="product-label">é¢åº¦èŒƒå›´</text>
              <text class="product-value">{{item.credit_range}}</text>
            </view>
            <view class="product-info-item">
              <text class="product-label">åˆ©ç‡</text>
              <text class="product-value">{{item.interest_rate}}</text>
            </view>
            <view class="product-info-item">
              <text class="product-label">æœŸé™</text>
              <text class="product-value">{{item.term}}</text>
            </view>
          </view>
          <view class="product-features">
            <text class="feature-label">äº§å“ç‰¹ç‚¹ï¼š</text>
            <text class="feature-text">{{item.features}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- AIåˆ†æ -->
    <view class="section ai-section">
      <view class="section-title">
        <text class="title-icon">ğŸ¤–</text>
        <text class="title-text">AIæ™ºèƒ½åˆ†æ</text>
      </view>

      <view class="suitability-rating">
        <text class="rating-label">é€‚åˆè´·æ¬¾ç”³è¯·ç¨‹åº¦</text>
        <text class="rating-value">{{suitabilityRating}}</text>
      </view>

      <view class="ai-points">
        <text class="points-title">åˆ†æè¦ç‚¹</text>
        <view wx:for="{{aiAnalysis}}" wx:key="index" class="ai-point">
          <text class="point-category">{{item.category}}</text>
          <text class="point-content">{{item.content}}</text>
        </view>
      </view>

      <view class="optimization-suggestions" wx:if="{{optimizationSuggestions.length > 0}}">
        <text class="suggestions-title">ä¼˜åŒ–å»ºè®®</text>
        <view wx:for="{{optimizationSuggestions}}" wx:key="index" class="suggestion-item">
          <text class="suggestion-icon">ğŸ’¡</text>
          <text class="suggestion-text">{{item}}</text>
        </view>
      </view>

      <view class="risk-warning" wx:if="{{riskWarning}}">
        <text class="warning-icon">âš ï¸</text>
        <text class="warning-text">{{riskWarning}}</text>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <button class="action-button primary" bindtap="downloadHTMLReport">
        <text class="button-icon">ğŸ“¥</text>
        <text class="button-text">ä¸‹è½½HTMLæŠ¥å‘Š</text>
      </button>
      <button class="action-button" open-type="share">
        <text class="button-icon">ğŸ“¤</text>
        <text class="button-text">åˆ†äº«æŠ¥å‘Š</text>
      </button>
    </view>
  </view>
</view>

