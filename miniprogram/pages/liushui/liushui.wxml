<!--liushui.wxml-->
<view class="container">
  <!-- 功能介绍 -->
  <view class="feature-intro">
    <view class="intro-title">💰 流水宝 · 银行流水分析</view>
    <view class="intro-desc">智能分析银行流水记录，洞察资金流向和消费习惯</view>
    <view class="intro-features">
      <view class="feature-tag">智能识别</view>
      <view class="feature-tag">资金分析</view>
      <view class="feature-tag">消费洞察</view>
    </view>
  </view>

  <!-- 上传区域 -->
  <view class="card upload-card">
    <view wx:if="{{!selectedFile}}" class="upload-area">
      <view class="upload-content" bind:tap="onChooseFile">
        <view class="upload-icon">☁️</view>
        <view class="upload-text">点击选择银行流水文件</view>
        <view class="upload-desc">支持 PDF 文档或图片截图，最大 10MB</view>
      </view>
      <t-button theme="primary" size="medium" style="margin-top: 20rpx;" bind:tap="onChooseFile">
        选择文件
      </t-button>
    </view>

    <!-- 已选择文件 -->
    <view wx:else class="selected-file">
      <view class="file-info">
        <view class="file-icon">📄</view>
        <view class="file-details">
          <view class="file-name">{{selectedFile.name}}</view>
          <view class="file-size">{{selectedFile.size}} 字节</view>
        </view>
        <view class="file-actions">
          <view class="remove-btn" bind:tap="onRemoveFile">✕</view>
        </view>
      </view>
    </view>

    <!-- 上传进度 -->
    <view wx:if="{{uploading}}" class="progress-section">
      <view class="progress-text">上传中... {{uploadProgress}}%</view>
      <t-progress percentage="{{uploadProgress}}" theme="primary" />
    </view>

    <!-- 分析进度 -->
    <view wx:if="{{generating}}" class="progress-section">
      <view class="progress-text">{{reportStatus}} {{reportProgress}}%</view>
      <t-progress percentage="{{reportProgress}}" theme="primary" />
      <view class="cancel-section">
        <t-button
          theme="default"
          size="medium"
          bind:tap="onCancelAnalysis"
          class="cancel-btn"
        >
          终止分析
        </t-button>
      </view>
    </view>

    <!-- 开始分析按钮 -->
    <view wx:if="{{selectedFile && !uploading && !generating}}" class="action-section">
      <t-button 
        theme="primary" 
        size="large" 
        block
        bind:tap="onStartAnalysis"
      >
        开始分析
      </t-button>
    </view>
  </view>

  <!-- 历史报告 -->
  <view class="card history-card">
    <view class="card-header">
      <view class="card-title">历史报告</view>
      <view class="date-filter">
        <picker 
          mode="selector" 
          range="{{dateOptions}}" 
          range-key="label"
          value="{{dateRange}}"
          bind:change="onDateRangeChange"
        >
          <view class="filter-text">更早 ▼</view>
        </picker>
      </view>
    </view>

    <!-- 报告列表 -->
    <view wx:if="{{reportList.length > 0}}" class="report-list">
      <view
        wx:for="{{reportList}}"
        wx:key="id"
        class="report-item {{item.status === 'failed' ? 'failed' : ''}} {{item.status === 'processing' ? 'processing' : ''}}"
      >
        <view class="report-icon">
          <text wx:if="{{item.status === 'completed'}}">🧾</text>
          <text wx:elif="{{item.status === 'processing'}}">⏳</text>
          <text wx:elif="{{item.status === 'failed'}}">❌</text>
          <text wx:else>📄</text>
        </view>
        <view class="report-info" data-report="{{item}}" bind:tap="onViewReport">
          <view class="report-title">{{item.title}}</view>
          <view class="report-date">{{item.date}}</view>
          <view wx:if="{{item.status === 'processing'}}" class="report-status processing">
            处理中 {{item.progress}}%
          </view>
          <view wx:elif="{{item.status === 'failed'}}" class="report-status failed">
            处理失败 - 点击重新生成
          </view>
          <view wx:elif="{{item.status === 'completed'}}" class="report-status completed">
            已完成 - 点击查看
          </view>
        </view>
        <view class="report-actions">
          <!-- 处理中的报告显示终止按钮 -->
          <view wx:if="{{item.status === 'processing'}}" class="action-btn cancel-action" data-report="{{item}}" catchtap="onCancelReportFromList">
            终止
          </view>
          <!-- 其他状态显示箭头 -->
          <view wx:else class="report-arrow" data-report="{{item}}" bind:tap="onViewReport">
            <text wx:if="{{item.status === 'failed'}}">🔄</text>
            <text wx:else>→</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 空状态 -->
    <view wx:else class="empty-state">
      <view class="empty-icon">📋</view>
      <view class="empty-text">暂无历史报告</view>
    </view>
  </view>

</view>
