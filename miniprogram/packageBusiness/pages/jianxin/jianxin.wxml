<!--jianxin.wxml-->
<view class="container">
  <!-- 认证提示 -->
  <view wx:if="{{needAuth}}" class="auth-notice">
    <view class="notice-content">
      <view class="notice-icon">🔐</view>
      <view class="notice-text">
        <view class="notice-title">需要实名认证</view>
        <view class="notice-desc">使用征信分析功能需要先完成实名认证</view>
      </view>
      <t-button theme="primary" size="small" bind:tap="goToAuth">
        去认证
      </t-button>
    </view>
  </view>

  <!-- 会员提示 -->
  <view wx:if="{{needMembership}}" class="membership-notice">
    <view class="notice-content">
      <view class="notice-icon">👑</view>
      <view class="notice-text">
        <view class="notice-title">{{membershipExpired ? '会员已过期' : '需要开通会员'}}</view>
        <view class="notice-desc">{{membershipExpired ? '您的会员已过期，请续费后继续使用' : '简信宝功能需要开通普通会员或高级会员'}}</view>
      </view>
      <t-button theme="primary" size="small" bind:tap="goToMembership">
        {{membershipExpired ? '去续费' : '去开通'}}
      </t-button>
    </view>
  </view>

  <!-- 功能介绍 -->
  <view class="feature-intro">
    <view class="intro-title">📄 简信宝 · 简版征信分析</view>
    <view class="intro-desc">快速解读征信报告核心信息，提供基础信用评估</view>
    <view class="intro-features">
      <view class="feature-tag">快速分析</view>
      <view class="feature-tag">核心信息</view>
      <view class="feature-tag">信用评估</view>
    </view>
  </view>

  <!-- 上传区域 -->
  <view class="card upload-card">
    <view wx:if="{{!selectedFile}}" class="upload-area">
      <view class="upload-content" bind:tap="onChooseFile">
        <view class="upload-icon">☁️</view>
        <view class="upload-text">点击选择征信报告文件</view>
        <view class="upload-desc">支持 PDF 文档或图片截图，最大 10MB</view>
      </view>
      <t-button theme="primary" size="medium" style="margin-top: 20rpx;" bind:tap="onChooseFile">
        选择文件
      </t-button>
    </view>

    <!-- 已选择文件 -->
    <view wx:else class="selected-file">
      <view class="file-info">
        <view class="file-icon">📄</view>
        <view class="file-details">
          <view class="file-name">{{selectedFile.name}}</view>
          <view class="file-size">{{selectedFile.size}} 字节</view>
        </view>
        <view class="file-actions">
          <view class="remove-btn" bind:tap="onRemoveFile">✕</view>
        </view>
      </view>
    </view>

    <!-- 上传进度 -->
    <view wx:if="{{uploading}}" class="progress-section">
      <view class="progress-text">上传中... {{uploadProgress}}%</view>
      <t-progress percentage="{{uploadProgress}}" theme="primary" />
    </view>

    <!-- 分析进度 -->
    <view wx:if="{{generating}}" class="progress-section">
      <view class="progress-text">{{reportStatus}} {{reportProgress}}%</view>
      <t-progress percentage="{{reportProgress}}" theme="primary" />
      <view class="cancel-section">
        <t-button
          theme="default"
          size="medium"
          bind:tap="onCancelAnalysis"
          class="cancel-btn"
        >
          终止分析
        </t-button>
      </view>
    </view>

    <!-- 开始分析按钮 -->
    <view wx:if="{{selectedFile && !uploading && !generating}}" class="action-section">
      <t-button 
        theme="primary" 
        size="large" 
        block
        bind:tap="onStartAnalysis"
      >
        开始分析
      </t-button>
    </view>
  </view>

  <!-- 历史报告 -->
  <view class="card history-card">
    <view class="card-header">
      <view class="card-title">历史报告</view>
    </view>

    <!-- 报告列表 -->
    <view wx:if="{{reportList.length > 0}}" class="report-list">
      <!-- 使用滑动删除组件 -->
      <view
        wx:for="{{reportList}}"
        wx:key="id"
        class="report-item-wrapper"
      >
        <view class="report-item-container">
          <!-- 报告内容 -->
          <view class="report-item {{item.status === 'failed' ? 'failed' : ''}} {{item.status === 'processing' ? 'processing' : ''}}">
            <!-- 失败状态的醒目标签 -->
            <view wx:if="{{item.status === 'failed'}}" class="failed-badge">
              <text class="failed-text">处理失败</text>
            </view>

            <!-- 处理中状态的进度标签 -->
            <view wx:elif="{{item.status === 'processing'}}" class="processing-badge">
              <text class="processing-text">处理中 {{item.progress}}%</text>
            </view>

            <view class="report-icon">
              <text wx:if="{{item.status === 'completed'}}">📊</text>
              <text wx:elif="{{item.status === 'processing'}}">⏳</text>
              <text wx:elif="{{item.status === 'failed'}}">⚠️</text>
              <text wx:else>📄</text>
            </view>
            <view class="report-info" data-report="{{item}}" bind:tap="onViewReport">
              <view class="report-title">{{item.title}}</view>
              <view class="report-date">{{item.date}}</view>
              <view wx:if="{{item.status === 'processing'}}" class="report-status processing">
                AI正在分析征信数据... {{item.progress}}%
              </view>
              <view wx:elif="{{item.status === 'failed'}}" class="report-status failed">
                文件损坏或分析出错 - 点击重新生成
              </view>
              <view wx:elif="{{item.status === 'completed'}}" class="report-status completed">
                征信分析完成 - 点击查看详情
              </view>
            </view>
            <view class="report-actions">
              <!-- 处理中的报告显示终止按钮 -->
              <view wx:if="{{item.status === 'processing'}}" class="action-btn cancel-action" data-report="{{item}}" catchtap="onCancelReportFromList">
                终止
              </view>
              <!-- 其他状态显示箭头 -->
              <view wx:else class="report-arrow" data-report="{{item}}" bind:tap="onViewReport">
                <text wx:if="{{item.status === 'failed'}}">🔄</text>
                <text wx:else>→</text>
              </view>
            </view>
          </view>

          <!-- 删除按钮 -->
          <view class="delete-btn" data-report="{{item}}" catchtap="onDeleteReport">
            <text class="delete-icon">🗑️</text>
            <text class="delete-text">删除</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 空状态 -->
    <view wx:else class="empty-state">
      <view class="empty-icon">📋</view>
      <view class="empty-text">暂无历史报告</view>
    </view>
  </view>

</view>
