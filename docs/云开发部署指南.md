# 资信猫小程序云开发部署指南

## 环境配置

### 1. 云开发环境
- 环境ID: `zixinmao-6gze9a8pef07503b`
- 已在 `miniprogram/app.ts` 中配置

### 2. 数据库集合

需要在云开发控制台创建以下数据库集合：

#### users 集合（用户信息）
```json
{
  "_id": "自动生成",
  "openid": "用户openid",
  "unionid": "用户unionid（可选）",
  "appid": "小程序appid",
  "nickName": "用户昵称",
  "avatarUrl": "头像URL",
  "gender": 0, // 0-未知，1-男，2-女
  "country": "国家",
  "province": "省份",
  "city": "城市",
  "language": "语言",
  "realNameVerified": false, // 是否实名认证
  "realName": "真实姓名",
  "idCard": "身份证号",
  "phone": "手机号",
  "balance": 0, // 账户余额（分）
  "totalRecharge": 0, // 总充值金额（分）
  "totalConsumption": 0, // 总消费金额（分）
  "memberLevel": "basic", // 会员等级：basic, premium, vip
  "memberExpireTime": null, // 会员到期时间
  "status": "active", // 账户状态：active, suspended, banned
  "createdAt": "创建时间",
  "updatedAt": "更新时间",
  "lastLoginAt": "最后登录时间",
  "loginCount": 1 // 登录次数
}
```

#### auth_logs 集合（认证日志）
```json
{
  "_id": "自动生成",
  "openid": "用户openid",
  "userId": "用户ID",
  "authType": "认证类型：realName",
  "authData": {
    "realName": "真实姓名",
    "idCard": "身份证号（脱敏）",
    "phone": "手机号（脱敏）"
  },
  "authResult": "认证结果：success, failed",
  "authTime": "认证时间"
}
```

### 3. 云函数部署

在微信开发者工具中，右键点击 `cloudFunctions` 文件夹下的每个云函数，选择"上传并部署"：

1. **login** - 用户登录
2. **updateUserInfo** - 更新用户信息
3. **getUserInfo** - 获取用户信息
4. **realNameAuth** - 实名认证

### 4. 数据库权限设置

在云开发控制台的数据库权限设置中：

#### users 集合权限
```json
{
  "read": "auth.openid == resource.openid",
  "write": "auth.openid == resource.openid"
}
```

#### auth_logs 集合权限
```json
{
  "read": "auth.openid == resource.openid",
  "write": false
}
```

## 部署步骤

### 1. 开发者工具配置
1. 打开微信开发者工具
2. 导入项目，选择 `miniprogram-2` 目录
3. 确保项目配置中的 `appid` 正确
4. 在工具栏点击"云开发"按钮

### 2. 云函数部署
1. 在左侧文件树中找到 `cloudFunctions` 目录
2. 右键点击每个云函数文件夹（login、updateUserInfo、getUserInfo、realNameAuth）
3. 选择"上传并部署：云端安装依赖"
4. 等待部署完成

### 3. 数据库初始化
1. 在云开发控制台进入数据库
2. 创建 `users` 集合
3. 创建 `auth_logs` 集合
4. 设置相应的权限规则

### 4. 测试验证
1. 在开发者工具中预览小程序
2. 测试登录功能
3. 测试实名认证功能
4. 检查数据库中的数据是否正确创建

## 注意事项

1. **环境ID**: 确保所有文件中的环境ID都是 `zixinmao-6gze9a8pef07503b`
2. **权限设置**: 数据库权限设置确保用户只能访问自己的数据
3. **实名认证**: 当前使用模拟认证，生产环境需要接入真实的第三方认证服务
4. **数据安全**: 敏感信息（如身份证号）在存储和传输时需要加密处理

## 功能说明

### 登录流程
1. 用户点击登录按钮
2. 调用 `wx.login()` 获取临时登录凭证
3. 调用 `login` 云函数进行登录
4. 云函数检查用户是否存在，不存在则创建新用户
5. 返回用户信息并保存到本地存储

### 实名认证流程
1. 用户填写真实姓名、身份证号、手机号
2. 前端进行基础格式验证
3. 调用 `realNameAuth` 云函数
4. 云函数进行重复性检查和格式验证
5. 调用第三方认证接口（当前为模拟）
6. 更新用户认证状态

### 用户信息更新
1. 用户修改头像、昵称等信息
2. 调用 `updateUserInfo` 云函数
3. 云函数验证权限并更新数据库
4. 返回更新后的用户信息
