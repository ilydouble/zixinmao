# 订单数据库集合设计

## 集合名称
`orders` - 用户订单记录

## 字段设计

### 基础字段
| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `_id` | String | 是 | 系统自动生成的唯一ID |
| `userId` | String | 是 | 用户openid |
| `orderNo` | String | 是 | 订单号，格式：R/C + 年月日时分秒 + 3位随机数 |
| `type` | String | 是 | 订单类型：recharge(充值)、consumption(消费) |
| `productName` | String | 是 | 产品名称 |
| `productCode` | String | 是 | 产品代码 |

### 金额字段
| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `amount` | Number | 是 | 实际金额 |
| `originalAmount` | Number | 是 | 原始金额 |
| `discountAmount` | Number | 否 | 优惠金额，默认0 |

### 状态字段
| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `status` | String | 是 | 订单状态：pending(待支付)、processing(处理中)、completed(已完成)、failed(失败)、cancelled(取消) |

### 支付字段（充值订单）
| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `paymentMethod` | String | 否 | 支付方式：wechat_pay、alipay等 |
| `paymentTime` | Date | 否 | 支付时间 |

### 查询字段（消费订单）
| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `queryParams` | Object | 否 | 查询参数（姓名、身份证等） |
| `resultData` | Object | 否 | 查询结果数据 |

### 描述字段
| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `description` | String | 否 | 订单描述 |
| `remark` | String | 否 | 备注信息 |

### 时间字段
| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `createdAt` | Date | 是 | 创建时间 |
| `updatedAt` | Date | 是 | 更新时间 |
| `completedAt` | Date | 否 | 完成时间 |

## 订单号规则

### 格式
`{前缀}{年月日时分秒}{3位随机数}`

### 前缀规则
- `R` - 充值订单 (Recharge)
- `C` - 消费订单 (Consumption)

### 示例
- 充值订单：`R20241201143025001`
- 消费订单：`C20241201143025002`

## 订单状态流转

### 充值订单
```
pending(待支付) → processing(处理中) → completed(已完成)
                                  ↘ failed(失败)
```

### 消费订单
```
processing(处理中) → completed(已完成)
                  ↘ failed(失败)
```

## 示例数据

### 充值订单
```json
{
  "_id": "order_001",
  "userId": "user_openid_123",
  "orderNo": "R20241201143025001",
  "type": "recharge",
  "productName": "账户充值",
  "productCode": "RECHARGE_100",
  "amount": 100.00,
  "originalAmount": 100.00,
  "discountAmount": 0,
  "status": "completed",
  "paymentMethod": "wechat_pay",
  "paymentTime": "2024-12-01T14:30:25.000Z",
  "description": "微信支付充值100元",
  "remark": "首次充值",
  "createdAt": "2024-12-01T14:30:00.000Z",
  "updatedAt": "2024-12-01T14:30:25.000Z",
  "completedAt": "2024-12-01T14:30:25.000Z"
}
```

### 消费订单
```json
{
  "_id": "order_002",
  "userId": "user_openid_123",
  "orderNo": "C20241201143525002",
  "type": "consumption",
  "productName": "简信宝查询",
  "productCode": "JIANXIN_QUERY",
  "amount": 15.00,
  "originalAmount": 15.00,
  "discountAmount": 0,
  "status": "completed",
  "queryParams": {
    "name": "张三",
    "idCard": "110101199001011234",
    "phone": "13800138000"
  },
  "resultData": {
    "hasRecord": true,
    "riskLevel": "low",
    "reportId": "JX20241201001"
  },
  "description": "简信宝个人信用查询",
  "remark": "查询成功",
  "createdAt": "2024-12-01T14:35:00.000Z",
  "updatedAt": "2024-12-01T14:35:25.000Z",
  "completedAt": "2024-12-01T14:35:25.000Z"
}
```

## 索引设计

### 主要索引
1. **用户订单索引**: `userId + createdAt(desc)`
   - 用途：按用户查询订单列表，按时间倒序
   
2. **订单号索引**: `orderNo(unique)`
   - 用途：通过订单号快速查找订单
   
3. **状态索引**: `userId + status + createdAt(desc)`
   - 用途：按用户和状态筛选订单

### 创建索引命令
```javascript
// 用户订单索引
db.orders.createIndex({ "userId": 1, "createdAt": -1 })

// 订单号唯一索引
db.orders.createIndex({ "orderNo": 1 }, { unique: true })

// 状态筛选索引
db.orders.createIndex({ "userId": 1, "status": 1, "createdAt": -1 })
```

## 查询示例

### 获取用户所有订单
```javascript
db.collection('orders')
  .where({ userId: 'user_openid_123' })
  .orderBy('createdAt', 'desc')
  .get()
```

### 按状态筛选订单
```javascript
db.collection('orders')
  .where({ 
    userId: 'user_openid_123',
    status: 'completed'
  })
  .orderBy('createdAt', 'desc')
  .get()
```

### 分页查询
```javascript
db.collection('orders')
  .where({ userId: 'user_openid_123' })
  .orderBy('createdAt', 'desc')
  .skip(0)
  .limit(10)
  .get()
```

## 统计查询

### 计算用户总消费
```javascript
// 所有已完成订单的金额总和
db.collection('orders')
  .where({ 
    userId: 'user_openid_123',
    status: 'completed'
  })
  .get()
  .then(res => {
    const total = res.data.reduce((sum, order) => sum + order.amount, 0)
    return total
  })
```

### 计算用户总充值
```javascript
// 所有已完成充值订单的金额总和
db.collection('orders')
  .where({ 
    userId: 'user_openid_123',
    type: 'recharge',
    status: 'completed'
  })
  .get()
  .then(res => {
    const total = res.data.reduce((sum, order) => sum + order.amount, 0)
    return total
  })
```

## 数据维护

### 定期清理
- 建议保留最近1年的订单数据
- 超过1年的数据可归档到历史表

### 数据备份
- 每日备份订单数据
- 重要订单数据实时同步

### 监控指标
- 订单创建成功率
- 支付成功率
- 查询成功率
- 平均处理时间
