# 资信猫小程序架构设计说明 (云函数优先版本)

## 架构原则

### 云函数优先原则
- **所有业务逻辑在云函数中处理**
- 前端只负责用户交互和状态同步
- 确保数据安全和业务逻辑的一致性
- 移除前端服务层，直接调用云函数

### 职责分离
- **云函数层**: 业务逻辑、数据验证、权限控制
- **前端工具层**: 云函数调用封装、状态同步
- **页面层**: 用户交互、数据展示

## 架构层次

```
┌─────────────────────────────────────┐
│              页面层 (Pages)           │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ │
│  │  登录页  │ │  首页   │ │个人中心 │ │
│  └─────────┘ └─────────┘ └─────────┘ │
└─────────────────────────────────────┘
                    │
┌─────────────────────────────────────┐
│           前端工具层 (Utils)           │
│  ┌─────────────────────────────────┐ │
│  │         auth.ts                 │ │
│  │  - 云函数调用封装                │ │
│  │  - 状态同步工具                  │ │
│  │  - 无业务逻辑                    │ │
│  └─────────────────────────────────┘ │
└─────────────────────────────────────┘
                    │
┌─────────────────────────────────────┐
│             云函数层 (Cloud)          │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ │
│  │  login  │ │getUserInfo│realNameAuth│ │
│  │  业务逻辑 │ │  权限控制 │ │  数据验证 │ │
│  └─────────┘ └─────────┘ └─────────┘ │
└─────────────────────────────────────┘
                    │
┌─────────────────────────────────────┐
│             数据层 (Database)         │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ │
│  │  users  │ │auth_logs│ │ orders  │ │
│  └─────────┘ └─────────┘ └─────────┘ │
└─────────────────────────────────────┘
```

## 核心组件

### 1. 前端工具层 (utils/auth.ts)

**职责**:
- 封装云函数调用
- 同步状态到全局数据和本地存储
- 提供简单的状态查询函数
- 统一错误处理和用户提示

**不包含**:
- 业务逻辑验证
- 数据格式验证
- 权限判断逻辑

```typescript
// 纯工具函数，无状态管理
async function login(): Promise<UserInfo> {
  // 直接调用云函数
  const response = await callCloudFunction<UserInfo>('login')
  // 同步状态
  updateGlobalUserState(response.userInfo, true)
  return response.userInfo
}

function isAuthenticated(): boolean {
  // 简单的状态查询
  const app = getApp()
  return app.globalData.isLoggedIn && !!app.globalData.userInfo?.openid
}
```

### 2. 云函数层

#### login 云函数
**职责**:
- 用户身份验证
- 新用户注册逻辑
- 登录日志记录
- 用户状态检查

#### updateUserInfo 云函数
**职责**:
- 用户信息更新验证
- 字段白名单检查
- 数据格式验证

#### realNameAuth 云函数
**职责**:
- 实名认证业务逻辑
- 第三方接口调用
- 重复认证检查
- 认证日志记录

#### getUserInfo 云函数
**职责**:
- 用户信息查询
- 权限验证
- 数据脱敏处理

## 数据流

### 登录流程
```
用户点击登录
    ↓
AuthStateManager.login()
    ↓
callCloudFunction('login')
    ↓
login 云函数处理业务逻辑
    ↓
返回用户信息
    ↓
AuthStateManager 更新本地状态
    ↓
页面更新 UI
```

### 实名认证流程
```
用户提交认证信息
    ↓
AuthStateManager.realNameAuth()
    ↓
callCloudFunction('realNameAuth')
    ↓
realNameAuth 云函数验证和处理
    ↓
调用第三方认证接口
    ↓
更新用户认证状态
    ↓
返回认证结果
    ↓
AuthStateManager 刷新用户信息
    ↓
页面显示认证结果
```

## 安全设计

### 1. 权限控制
- 所有数据库操作在云函数中进行
- 用户只能访问自己的数据
- 敏感操作需要额外验证

### 2. 数据验证
- 前端进行基础格式验证
- 云函数进行完整业务验证
- 数据库层面的约束检查

### 3. 数据脱敏
- 敏感信息在传输时脱敏
- 日志记录时隐藏关键信息
- 前端显示时部分隐藏

## 扩展性设计

### 1. 云函数模块化
- 每个云函数职责单一
- 可独立部署和更新
- 便于水平扩展

### 2. 前端服务层
- 统一的云函数调用接口
- 可插拔的状态管理
- 支持多种缓存策略

### 3. 数据库设计
- 合理的集合划分
- 支持索引优化
- 便于数据迁移

## 最佳实践

### 1. 云函数开发
- 单一职责原则
- 完整的错误处理
- 详细的日志记录
- 参数验证和类型检查

### 2. 前端开发
- 状态管理与业务逻辑分离
- 统一的错误处理
- 合理的缓存策略
- 用户体验优化

### 3. 数据库操作
- 使用事务保证数据一致性
- 合理的权限设置
- 定期备份和监控
- 性能优化

## 部署和监控

### 1. 云函数部署
- 版本管理
- 灰度发布
- 回滚机制

### 2. 监控告警
- 云函数执行监控
- 数据库性能监控
- 用户行为分析

### 3. 日志管理
- 结构化日志
- 日志聚合分析
- 问题追踪
