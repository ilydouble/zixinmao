# 用户权限管理

## 用户角色定义

### 1. 个人用户 (user)
- **注册方式**: 微信一键注册
- **微信关联**: 基于微信OpenID自动创建账户，支持免登录
- **所属企业**: 注册后可在设置中选择企业，默认归属根企业
- **使用平台**: 微信小程序
- **权限范围**: 
  - 查看和生成个人征信报告（需实名认证）
  - 管理个人账户信息
  - 消费资信币进行查询服务
  - 实名认证（使用简信宝、专信宝必需）

### 2. 企业用户 (companyUser)
- **注册方式**: 后台自主注册创建企业
- **认证流程**: 需填写企业资质信息，等待后台审批
- **使用平台**: 独立运营管理平台（非小程序）
- **权限范围**:
  - 查看和管理本企业下的所有用户
  - 设置本企业资信币单价（需≥基础价格）
  - 企业用户数据统计和分析
  - 批量用户管理

### 3. 超级管理员 (root)
- **职责**: 系统运营管理
- **使用平台**: 独立运营管理平台
- **权限范围**:
  - 审批企业用户注册申请
  - 查看所有企业和用户数据
  - 设置资信币基础价格
  - 系统配置和维护
  - 数据统计和报表

## 平台架构

### 微信小程序端
- **目标用户**: 仅支持个人用户
- **核心功能**: 
  - 微信一键登录注册
  - 个人征信查询（需实名认证）
  - 账户余额管理
  - 实名认证
  - 选择所属企业

### 运营管理平台
- **目标用户**: 企业用户 + 超级管理员
- **核心功能**:
  - 企业注册和审批
  - 用户管理
  - 价格设置
  - 数据统计

## 用户注册流程

### 个人用户注册流程
```
微信授权 → 自动创建账户 → 完善基本信息(可选) → 选择所属企业(可选)
```

**详细步骤**:
1. **微信授权**: 用户首次进入小程序，点击授权登录
2. **自动注册**: 系统基于微信OpenID自动创建用户账户
3. **基本信息**: 获取微信昵称、头像等基本信息
4. **完善资料**: 用户可选择完善个人资料
5. **选择企业**: 可在设置中选择所属企业，默认归属根企业

### 企业用户注册流程
```
平台注册 → 填写企业信息 → 上传资质文件 → 等待审批 → 审批通过 → 账户激活
```

## 数据库设计

### users 表（个人用户）
```javascript
{
  _id: "用户唯一ID",
  openid: "微信OpenID",
  unionid: "微信UnionID",
  nickName: "微信昵称",
  avatarUrl: "微信头像",
  
  // 实名认证信息
  realNameVerified: false, // 是否实名认证
  realName: "", // 真实姓名
  idCard: "", // 身份证号（加密）
  phone: "", // 手机号
  
  // 企业关联 - 对应现有的 organizationId 和 organizationName
  organizationId: "", // 所属企业ID（关联 organizations._id）
  organizationName: "", // 所属企业名称
  cityCode: "", // 所属城市代码
  cityName: "", // 所属城市名称
  
  // 账户信息
  balance: 0, // 资信币余额
  totalRecharge: 0, // 总充值金额
  totalConsumption: 0, // 总消费金额
  memberLevel: "basic", // 会员等级
  
  // 状态信息
  status: "active", // 账户状态
  createdAt: "注册时间",
  updatedAt: "更新时间",
  lastLoginAt: "最后登录时间"
}
```

### organizations 表（企业信息）- 对应现有的 organizations 集合
```javascript
{
  _id: "企业ID",
  name: "企业名称", // 对应现有的 name 字段
  code: "企业代码", // 对应现有的 code 字段
  type: "company", // 统一为企业类型
  description: "企业描述", // 对应现有的 description 字段
  
  // 企业详细信息
  legalPerson: "法人代表",
  businessLicense: "营业执照号",
  contactPhone: "联系电话",
  contactEmail: "联系邮箱",
  address: "企业地址",
  
  // 企业管理信息
  adminUsers: [], // 管理员用户列表
  coinPrice: 0, // 资信币单价（企业自定义价格）
  
  // 状态信息
  status: "active", // 对应现有的 status 字段：active/pending/rejected
  sort: 1, // 对应现有的 sort 字段
  createdAt: "创建时间", // 对应现有的 createdAt 字段
  approvedAt: "审批时间",
  approvedBy: "审批人"
}
```

### company_admins 表（企业管理员）
```javascript
{
  _id: "管理员ID",
  username: "管理员账号",
  password: "加密密码",
  organizationId: "关联企业ID", // 关联 organizations._id
  organizationName: "关联企业名称",
  permissions: [], // 权限列表
  status: "active", // 账户状态
  createdAt: "创建时间",
  lastLoginAt: "最后登录时间"
}
```

## 企业关联逻辑

### 个人用户选择企业
```javascript
// 获取企业列表（对应现有的 getOrganizations 云函数）
const organizations = await db.collection('organizations')
  .where({ 
    status: 'active',
    type: 'company' // 只获取企业类型
  })
  .orderBy('sort', 'asc')
  .get()

// 用户选择企业后更新用户信息
await db.collection('users').doc(userId).update({
  data: {
    organizationId: selectedOrg._id,
    organizationName: selectedOrg.name,
    updatedAt: new Date()
  }
})
```

### 企业用户管理
```javascript
// 企业管理员查看本企业用户
const companyUsers = await db.collection('users')
  .where({ 
    organizationId: adminUser.organizationId,
    status: 'active'
  })
  .get()

// 统计企业用户数据
const userStats = {
  totalUsers: companyUsers.data.length,
  verifiedUsers: companyUsers.data.filter(u => u.realNameVerified).length,
  totalConsumption: companyUsers.data.reduce((sum, u) => sum + u.totalConsumption, 0)
}
```

## 权限控制

### 数据访问权限
- **个人用户**: 只能访问自己的数据
- **企业用户**: 只能访问本企业用户数据
- **超级管理员**: 可访问所有数据

### 功能权限矩阵
| 功能 | 个人用户 | 企业用户 | 超级管理员 |
|------|----------|----------|------------|
| 征信查询 | ✅ | ❌ | ✅ |
| 用户管理 | ❌ | ✅(本企业) | ✅(全部) |
| 价格设置 | ❌ | ✅(企业价格) | ✅(基础价格) |
| 企业审批 | ❌ | ❌ | ✅ |
| 系统配置 | ❌ | ❌ | ✅ |

## 预置企业数据

### 根企业（默认企业）
```javascript
{
  name: '西安海之源科技服务有限公司',
  code: 'HAIYUAN_TECH',
  type: 'company',
  description: '默认根企业，为未选择企业的用户提供服务',
  status: 'active',
  sort: 0,
  isDefault: true // 标识为默认企业
}
```

### 示例企业数据
```javascript
[
  {
    name: '阿里巴巴集团',
    code: 'ALIBABA',
    type: 'company',
    description: '阿里巴巴集团控股有限公司',
    status: 'active',
    sort: 1
  },
  {
    name: '腾讯科技',
    code: 'TENCENT',
    type: 'company',
    description: '深圳市腾讯计算机系统有限公司',
    status: 'active',
    sort: 2
  },
  {
    name: '百度公司',
    code: 'BAIDU',
    type: 'company',
    description: '北京百度网讯科技有限公司',
    status: 'active',
    sort: 3
  },
  {
    name: '京东集团',
    code: 'JD',
    type: 'company',
    description: '北京京东世纪贸易有限公司',
    status: 'active',
    sort: 4
  },
  {
    name: '美团公司',
    code: 'MEITUAN',
    type: 'company',
    description: '北京三快在线科技有限公司',
    status: 'active',
    sort: 5
  }
]
```

## 企业管理流程

### 企业注册审批流程
```
企业提交注册申请 → 填写企业基本信息 → 上传营业执照等资质 → 系统审核 → 审批通过/拒绝 → 通知结果
```

### 企业用户权限设置
```
创建企业管理员账号 → 分配企业权限 → 设置资信币价格 → 开始管理企业用户
```

## 现有代码适配

### 云函数修改
```javascript
// cloudFunctions/getOrganizations/index.js 需要过滤企业类型
const orgQuery = await db.collection('organizations').where({
  status: 'active',
  type: 'company' // 只返回企业类型
}).orderBy('sort', 'asc').get()
```

### 初始化数据修改
```javascript
// scripts/init-settings-data.js 需要更新为企业数据
const organizations = [
  {
    name: '西安海之源科技服务有限公司',
    code: 'HAIYUAN_TECH',
    type: 'company', // 统一为 company 类型
    description: '默认根企业',
    status: 'active',
    sort: 0,
    isDefault: true
  },
  // ... 其他企业数据
]
```

## 注意事项

1. **类型统一**: 所有组织类型统一为 `company`
2. **默认企业**: 保留根企业作为默认选项
3. **数据迁移**: 现有数据需要将 `type` 字段统一更新为 `company`
4. **企业审批**: 新企业注册需要审批流程
5. **价格管控**: 企业自定义价格不能低于系统基础价格
6. **用户归属**: 未选择企业的用户默认归属根企业
