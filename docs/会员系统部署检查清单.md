# 会员系统部署检查清单

## ❌ 当前问题
无法加载会员配置，访问云函数失败

## 🔍 排查步骤

### 1. 检查云函数是否已部署

在微信开发者工具中：

1. 打开"云开发"控制台
2. 点击"云函数"
3. 查看 `getMembershipConfig` 是否在列表中
4. 查看状态是否为"已部署"

**如果没有部署：**
- 右键 `cloudFunctions/getMembershipConfig` 文件夹
- 选择"上传并部署：云端安装依赖"
- 等待部署完成

### 2. 检查数据库集合是否已创建

在微信开发者工具中：

1. 打开"云开发"控制台
2. 点击"数据库"
3. 查看是否有 `membership_config` 集合
4. 查看集合中是否有 3 条记录（free, basic, premium）

**如果没有集合：**
- 点击"添加集合"
- 输入集合名称：`membership_config`
- 点击"导入"按钮
- 选择 `docs/aa.json` 文件
- 导入模式选择：**JSON Lines**
- 点击"确定"

### 3. 检查云开发环境是否初始化

在 `miniprogram/app.ts` 中检查：

```typescript
wx.cloud.init({
  env: 'your-env-id',  // 确保环境ID正确
  traceUser: true
})
```

**如果没有初始化：**
- 在 `app.ts` 的 `onLaunch` 中添加云开发初始化代码
- 确保环境ID正确（在云开发控制台查看）

### 4. 检查云函数权限

在云开发控制台：

1. 点击"设置" → "权限设置"
2. 确保"所有用户可读，仅创建者可写"或更宽松的权限
3. 确保云函数有访问数据库的权限

### 5. 查看控制台日志

在微信开发者工具中：

1. 打开"调试器" → "Console"
2. 重新加载充值页面或个人中心
3. 查看日志输出：
   - `开始调用 getMembershipConfig 云函数`
   - `云函数调用结果: ...`
   - `云函数返回数据: ...`

**常见错误信息：**

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| `cloud function not found` | 云函数未部署 | 部署云函数 |
| `collection not found` | 数据库集合不存在 | 创建集合并导入数据 |
| `errCode: -1` | 云开发未初始化 | 检查 app.ts 中的初始化代码 |
| `permission denied` | 权限不足 | 检查数据库权限设置 |
| `timeout` | 网络超时 | 检查网络连接 |

### 6. 测试云函数

在云开发控制台：

1. 点击"云函数" → `getMembershipConfig`
2. 点击"测试"按钮
3. 输入测试参数：
   ```json
   {}
   ```
4. 点击"运行测试"
5. 查看返回结果是否正确

**期望的返回结果：**
```json
{
  "success": true,
  "data": [
    {
      "_id": "free",
      "type": "free",
      "name": "免费用户",
      ...
    },
    {
      "_id": "basic",
      "type": "basic",
      "name": "普通会员",
      ...
    },
    {
      "_id": "premium",
      "type": "premium",
      "name": "高级会员",
      ...
    }
  ]
}
```

### 7. 检查 purchaseMembership 云函数

同样需要部署 `purchaseMembership` 云函数：

1. 右键 `cloudFunctions/purchaseMembership` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

## ✅ 完整部署流程

### 步骤 1：部署云函数

```bash
# 在微信开发者工具中
# 右键以下文件夹，选择"上传并部署：云端安装依赖"
cloudFunctions/getMembershipConfig
cloudFunctions/purchaseMembership
```

### 步骤 2：创建数据库集合

1. 打开云开发控制台 → 数据库
2. 点击"添加集合"，输入：`membership_config`
3. 点击"导入"，选择 `docs/aa.json`
4. 导入模式：**JSON Lines**
5. 确认导入成功，应该有 3 条记录

### 步骤 3：验证数据

在数据库中查看 `membership_config` 集合：

- ✅ 有 3 条记录
- ✅ 每条记录都有 `_id`, `type`, `name`, `prices` 等字段
- ✅ `enabled` 字段都为 `true`
- ✅ `prices` 对象包含 `monthly`, `quarterly`, `yearly`

### 步骤 4：测试功能

1. 打开小程序
2. 进入个人中心
   - 查看控制台日志
   - 确认会员信息正确显示
3. 进入充值页面
   - 查看控制台日志
   - 确认会员类型和价格正确显示
   - 切换会员类型，价格应该更新
   - 切换时长，价格应该更新

## 🐛 调试技巧

### 查看详细日志

现在代码中已经添加了详细的日志输出：

```typescript
// 充值页面
console.log('开始调用 getMembershipConfig 云函数')
console.log('云函数调用结果:', result)
console.log('云函数返回数据:', response)
console.log('会员配置数据:', response.data)
console.log('过滤后的会员类型:', membershipTypes)

// 个人中心
console.log('个人中心 - 开始获取会员配置, memberType:', memberType)
console.log('个人中心 - 云函数调用结果:', result)
console.log('个人中心 - 成功获取会员配置:', response.data)
```

### 使用云函数日志

在云开发控制台：

1. 点击"云函数" → `getMembershipConfig`
2. 点击"日志"标签
3. 查看最近的调用记录和错误信息

### 使用数据库监控

在云开发控制台：

1. 点击"数据库" → "监控"
2. 查看请求量、错误率等指标

## 📞 常见问题

### Q: 提示"cloud function not found"
**A:** 云函数未部署，请按照步骤 1 部署云函数

### Q: 提示"collection not found"
**A:** 数据库集合不存在，请按照步骤 2 创建集合并导入数据

### Q: 数据导入失败
**A:** 确保选择了"JSON Lines"格式，而不是"JSON 数组"

### Q: 云函数部署失败
**A:** 检查 `package.json` 中的依赖是否正确，确保网络连接正常

### Q: 个人中心显示正常，但充值页面加载失败
**A:** 充值页面需要获取所有会员配置，个人中心只获取单个配置。检查数据库中是否有完整的 3 条记录

## 🎯 验证成功的标志

- ✅ 个人中心显示会员信息（免费用户/普通会员/高级会员）
- ✅ 充值页面显示两种会员类型（普通会员、高级会员）
- ✅ 每个会员类型显示 3 种时长选项
- ✅ 每个时长选项显示对应的价格
- ✅ 切换会员类型时，价格自动更新
- ✅ 切换时长时，价格自动更新
- ✅ 控制台没有错误日志

如果以上都正常，说明会员系统部署成功！🎉

