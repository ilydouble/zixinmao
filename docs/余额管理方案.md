# ä½™é¢ç®¡ç†æ–¹æ¡ˆ

## ğŸ¯ ç›®æ ‡
è§£å†³ä¸ªäººä¸­å¿ƒè´¦æˆ·ä¿¡æ¯å’Œä½™é¢é¡µé¢æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå»ºç«‹ç»Ÿä¸€çš„ä½™é¢ç®¡ç†æœºåˆ¶ã€‚

## ğŸ“Š å½“å‰é—®é¢˜
1. **ä¸ªäººä¸­å¿ƒè´¦æˆ·ä¿¡æ¯** â†’ è¯»å– `users.balance` å­—æ®µ
2. **ä½™é¢é¡µé¢** â†’ å®æ—¶è®¡ç®— `recharge_records` + `orders` æ•°æ®
3. **æ•°æ®ä¸ä¸€è‡´** â†’ ä¸¤ä¸ªæ•°æ®æºå¯èƒ½æ˜¾ç¤ºä¸åŒçš„ä½™é¢

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### 1. ç»Ÿä¸€æ•°æ®æºç­–ç•¥
- **ä¸»æ•°æ®æº**ï¼š`users.balance` å­—æ®µï¼ˆå¿«é€ŸæŸ¥è¯¢ï¼Œç”¨äºæ˜¾ç¤ºï¼‰
- **æ ¡éªŒæ•°æ®æº**ï¼šå®æ—¶è®¡ç®—äº¤æ˜“è®°å½•ï¼ˆæ•°æ®æ ¡éªŒï¼Œç¡®ä¿å‡†ç¡®æ€§ï¼‰

### 2. äº¤æ˜“è®°å½•æ˜¾ç¤ºè§„åˆ™
- **æœ€è¿‘è´¦å˜**ï¼šåªæ˜¾ç¤º `status = 'completed'` çš„äº¤æ˜“è®°å½•
- **å……å€¼è®°å½•**ï¼šå¤±è´¥æˆ–å¾…å¤„ç†çš„å……å€¼ä¸æ˜¾ç¤ºï¼ˆå› ä¸ºæ²¡æœ‰å®é™…å½±å“ä½™é¢ï¼‰
- **æ¶ˆè´¹è®°å½•**ï¼šå¤±è´¥æˆ–å¤„ç†ä¸­çš„æ¶ˆè´¹ä¸æ˜¾ç¤ºï¼ˆå› ä¸ºæ²¡æœ‰å®é™…æ‰£è´¹ï¼‰

### 3. æ•°æ®æ›´æ–°æµç¨‹

#### å……å€¼æˆåŠŸæµç¨‹ï¼š
```
ç”¨æˆ·å‘èµ·å……å€¼ â†’ åˆ›å»ºå……å€¼è®°å½• â†’ æ”¯ä»˜æˆåŠŸ â†’ æ›´æ–°ä½™é¢
```

```javascript
// 1. åˆ›å»ºå……å€¼è®°å½•
await db.collection('recharge_records').add({
  data: {
    userId: OPENID,
    rechargeNo: generateRechargeNo(),
    amount: 100.00,
    status: 'pending',
    // ... å…¶ä»–å­—æ®µ
  }
})

// 2. æ”¯ä»˜æˆåŠŸåæ›´æ–°çŠ¶æ€å’Œä½™é¢
await db.collection('recharge_records').doc(recordId).update({
  data: {
    status: 'completed',
    completedAt: new Date()
  }
})

// 3. æ›´æ–°ç”¨æˆ·ä½™é¢
await db.collection('users').doc(userId).update({
  data: {
    balance: db.command.inc(100.00),
    totalRecharge: db.command.inc(100.00),
    updatedAt: new Date()
  }
})
```

#### æ¶ˆè´¹æˆåŠŸæµç¨‹ï¼š
```
ç”¨æˆ·å‘èµ·æŸ¥è¯¢ â†’ åˆ›å»ºæ¶ˆè´¹è®¢å• â†’ æ‰£é™¤ä½™é¢ â†’ æ‰§è¡ŒæŸ¥è¯¢
```

```javascript
// 1. æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ
const user = await db.collection('users').doc(userId).get()
if (user.data.balance < orderAmount) {
  throw new Error('ä½™é¢ä¸è¶³')
}

// 2. åˆ›å»ºæ¶ˆè´¹è®¢å•
await db.collection('orders').add({
  data: {
    userId: OPENID,
    orderNo: generateOrderNo('C'),
    amount: 15.00,
    status: 'processing',
    // ... å…¶ä»–å­—æ®µ
  }
})

// 3. æ‰£é™¤ä½™é¢
await db.collection('users').doc(userId).update({
  data: {
    balance: db.command.inc(-15.00),
    totalConsumption: db.command.inc(15.00),
    updatedAt: new Date()
  }
})

// 4. æ‰§è¡ŒæŸ¥è¯¢æœåŠ¡
// ... æŸ¥è¯¢é€»è¾‘

// 5. æ›´æ–°è®¢å•çŠ¶æ€
await db.collection('orders').doc(orderId).update({
  data: {
    status: 'completed',
    completedAt: new Date()
  }
})
```

### 3. æ•°æ®ä¸€è‡´æ€§ä¿éšœ

#### åŒæ­¥ä½™é¢äº‘å‡½æ•°ï¼š`syncUserBalance`
- é‡æ–°è®¡ç®—ç”¨æˆ·å®é™…ä½™é¢
- æ›´æ–° `users` è¡¨ä¸­çš„ä½™é¢å’Œç»Ÿè®¡æ•°æ®
- ç”¨äºæ•°æ®ä¿®å¤å’Œå®šæœŸæ ¡éªŒ

#### ä½™é¢æ ¡éªŒæœºåˆ¶ï¼š
```javascript
// åœ¨ getUserBalance äº‘å‡½æ•°ä¸­
const userBalance = user.balance || 0
const calculatedBalance = calculateFromTransactions()
const isConsistent = Math.abs(userBalance - calculatedBalance) < 0.01

if (!isConsistent) {
  console.warn('ä½™é¢æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦åŒæ­¥')
  // å¯ä»¥è‡ªåŠ¨è§¦å‘åŒæ­¥æˆ–å‘é€å‘Šè­¦
}
```

## ğŸš€ åç»­å®ç°è®¡åˆ’

### Phase 1: å……å€¼åŠŸèƒ½
1. **åˆ›å»ºå……å€¼é¡µé¢**
   - é€‰æ‹©å……å€¼é‡‘é¢
   - å¾®ä¿¡æ”¯ä»˜é›†æˆ
   - æ”¯ä»˜çŠ¶æ€å¤„ç†

2. **å……å€¼äº‘å‡½æ•°**
   - `createRechargeOrder` - åˆ›å»ºå……å€¼è®¢å•
   - `handleRechargeCallback` - å¤„ç†æ”¯ä»˜å›è°ƒ
   - `updateUserBalance` - æ›´æ–°ç”¨æˆ·ä½™é¢

3. **æ”¯ä»˜æµç¨‹**
   ```
   é€‰æ‹©é‡‘é¢ â†’ åˆ›å»ºè®¢å• â†’ è°ƒèµ·æ”¯ä»˜ â†’ æ”¯ä»˜æˆåŠŸ â†’ æ›´æ–°ä½™é¢ â†’ åˆ·æ–°é¡µé¢
   ```

### Phase 2: æ¶ˆè´¹åŠŸèƒ½
1. **æŸ¥è¯¢æœåŠ¡é›†æˆ**
   - ç®€ä¿¡å®æŸ¥è¯¢
   - ä¸“ä¿¡å®æŸ¥è¯¢
   - æµæ°´å®æŸ¥è¯¢

2. **æ¶ˆè´¹äº‘å‡½æ•°**
   - `createConsumptionOrder` - åˆ›å»ºæ¶ˆè´¹è®¢å•
   - `executeQuery` - æ‰§è¡ŒæŸ¥è¯¢æœåŠ¡
   - `completeOrder` - å®Œæˆè®¢å•

3. **æ¶ˆè´¹æµç¨‹**
   ```
   é€‰æ‹©æœåŠ¡ â†’ æ£€æŸ¥ä½™é¢ â†’ åˆ›å»ºè®¢å• â†’ æ‰£é™¤ä½™é¢ â†’ æ‰§è¡ŒæŸ¥è¯¢ â†’ è¿”å›ç»“æœ
   ```

### Phase 3: é«˜çº§åŠŸèƒ½
1. **ä½™é¢é¢„è­¦**
   - ä½™é¢ä¸è¶³æé†’
   - è‡ªåŠ¨å……å€¼å»ºè®®

2. **äº¤æ˜“è®°å½•**
   - è¯¦ç»†äº¤æ˜“å†å²
   - å¯¼å‡ºåŠŸèƒ½

3. **ä¼šå‘˜æƒç›Š**
   - ä¼šå‘˜æŠ˜æ‰£
   - ç§¯åˆ†ç³»ç»Ÿ

## ğŸ“‹ æ•°æ®åº“å­—æ®µè®¾è®¡

### users è¡¨æ–°å¢å­—æ®µï¼š
```javascript
{
  balance: Number,              // å½“å‰ä½™é¢
  totalRecharge: Number,        // æ€»å……å€¼é‡‘é¢
  totalConsumption: Number,     // æ€»æ¶ˆè´¹é‡‘é¢
  lastBalanceSyncAt: Date,      // æœ€åä½™é¢åŒæ­¥æ—¶é—´
  balanceVersion: Number        // ä½™é¢ç‰ˆæœ¬å·ï¼ˆç”¨äºå¹¶å‘æ§åˆ¶ï¼‰
}
```

### recharge_records è¡¨ï¼š
```javascript
{
  userId: String,               // ç”¨æˆ·ID
  rechargeNo: String,           // å……å€¼å•å·
  amount: Number,               // å……å€¼é‡‘é¢
  status: String,               // çŠ¶æ€ï¼špending/completed/failed
  paymentMethod: String,        // æ”¯ä»˜æ–¹å¼
  transactionId: String,        // äº¤æ˜“ID
  createdAt: Date,              // åˆ›å»ºæ—¶é—´
  completedAt: Date             // å®Œæˆæ—¶é—´
}
```

### orders è¡¨ï¼š
```javascript
{
  userId: String,               // ç”¨æˆ·ID
  orderNo: String,              // è®¢å•å·
  productName: String,          // äº§å“åç§°
  amount: Number,               // è®¢å•é‡‘é¢
  status: String,               // çŠ¶æ€ï¼šprocessing/completed/failed
  queryParams: Object,          // æŸ¥è¯¢å‚æ•°
  resultData: Object,           // æŸ¥è¯¢ç»“æœ
  createdAt: Date,              // åˆ›å»ºæ—¶é—´
  completedAt: Date             // å®Œæˆæ—¶é—´
}
```

## ğŸ”’ å®‰å…¨è€ƒè™‘

1. **å¹¶å‘æ§åˆ¶**
   - ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡
   - ä¹è§‚é”æœºåˆ¶
   - ä½™é¢ç‰ˆæœ¬å·

2. **æ•°æ®æ ¡éªŒ**
   - é‡‘é¢èŒƒå›´æ£€æŸ¥
   - ä½™é¢å……è¶³æ€§éªŒè¯
   - é‡å¤æäº¤é˜²æŠ¤

3. **æ—¥å¿—è®°å½•**
   - æ‰€æœ‰ä½™é¢å˜åŠ¨è®°å½•
   - å¼‚å¸¸æƒ…å†µå‘Šè­¦
   - å®¡è®¡æ—¥å¿—

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

1. **ä¸šåŠ¡æŒ‡æ ‡**
   - å……å€¼æˆåŠŸç‡
   - æ¶ˆè´¹æˆåŠŸç‡
   - ä½™é¢ä¸€è‡´æ€§

2. **æŠ€æœ¯æŒ‡æ ‡**
   - æ¥å£å“åº”æ—¶é—´
   - é”™è¯¯ç‡
   - å¹¶å‘å¤„ç†èƒ½åŠ›

## ğŸ¯ å½“å‰çŠ¶æ€

âœ… **å·²å®Œæˆ**ï¼š
- ä½™é¢æ˜¾ç¤ºç»Ÿä¸€ï¼ˆä½¿ç”¨ users.balanceï¼‰
- æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
- åŒæ­¥ä½™é¢åŠŸèƒ½
- äº¤æ˜“è®°å½•æŸ¥è¯¢

ğŸ”„ **è¿›è¡Œä¸­**ï¼š
- æ•°æ®æºç»Ÿä¸€ä¼˜åŒ–

ğŸ“‹ **å¾…å®ç°**ï¼š
- å……å€¼åŠŸèƒ½
- æ¶ˆè´¹åŠŸèƒ½
- æ”¯ä»˜é›†æˆ
- é«˜çº§åŠŸèƒ½
