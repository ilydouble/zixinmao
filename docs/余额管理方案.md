# 余额管理方案

## 🎯 目标
解决个人中心账户信息和余额页面数据不一致的问题，建立统一的余额管理机制。

## 📊 当前问题
1. **个人中心账户信息** → 读取 `users.balance` 字段
2. **余额页面** → 实时计算 `recharge_records` + `orders` 数据
3. **数据不一致** → 两个数据源可能显示不同的余额

## 🔧 解决方案

### 1. 统一数据源策略
- **主数据源**：`users.balance` 字段（快速查询，用于显示）
- **校验数据源**：实时计算交易记录（数据校验，确保准确性）

### 2. 交易记录显示规则
- **最近账变**：只显示 `status = 'completed'` 的交易记录
- **充值记录**：失败或待处理的充值不显示（因为没有实际影响余额）
- **消费记录**：失败或处理中的消费不显示（因为没有实际扣费）

### 3. 数据更新流程

#### 充值成功流程：
```
用户发起充值 → 创建充值记录 → 支付成功 → 更新余额
```

```javascript
// 1. 创建充值记录
await db.collection('recharge_records').add({
  data: {
    userId: OPENID,
    rechargeNo: generateRechargeNo(),
    amount: 100.00,
    status: 'pending',
    // ... 其他字段
  }
})

// 2. 支付成功后更新状态和余额
await db.collection('recharge_records').doc(recordId).update({
  data: {
    status: 'completed',
    completedAt: new Date()
  }
})

// 3. 更新用户余额
await db.collection('users').doc(userId).update({
  data: {
    balance: db.command.inc(100.00),
    totalRecharge: db.command.inc(100.00),
    updatedAt: new Date()
  }
})
```

#### 消费成功流程：
```
用户发起查询 → 创建消费订单 → 扣除余额 → 执行查询
```

```javascript
// 1. 检查余额是否足够
const user = await db.collection('users').doc(userId).get()
if (user.data.balance < orderAmount) {
  throw new Error('余额不足')
}

// 2. 创建消费订单
await db.collection('orders').add({
  data: {
    userId: OPENID,
    orderNo: generateOrderNo('C'),
    amount: 15.00,
    status: 'processing',
    // ... 其他字段
  }
})

// 3. 扣除余额
await db.collection('users').doc(userId).update({
  data: {
    balance: db.command.inc(-15.00),
    totalConsumption: db.command.inc(15.00),
    updatedAt: new Date()
  }
})

// 4. 执行查询服务
// ... 查询逻辑

// 5. 更新订单状态
await db.collection('orders').doc(orderId).update({
  data: {
    status: 'completed',
    completedAt: new Date()
  }
})
```

### 3. 数据一致性保障

#### 同步余额云函数：`syncUserBalance`
- 重新计算用户实际余额
- 更新 `users` 表中的余额和统计数据
- 用于数据修复和定期校验

#### 余额校验机制：
```javascript
// 在 getUserBalance 云函数中
const userBalance = user.balance || 0
const calculatedBalance = calculateFromTransactions()
const isConsistent = Math.abs(userBalance - calculatedBalance) < 0.01

if (!isConsistent) {
  console.warn('余额数据不一致，需要同步')
  // 可以自动触发同步或发送告警
}
```

## 🚀 后续实现计划

### Phase 1: 充值功能
1. **创建充值页面**
   - 选择充值金额
   - 微信支付集成
   - 支付状态处理

2. **充值云函数**
   - `createRechargeOrder` - 创建充值订单
   - `handleRechargeCallback` - 处理支付回调
   - `updateUserBalance` - 更新用户余额

3. **支付流程**
   ```
   选择金额 → 创建订单 → 调起支付 → 支付成功 → 更新余额 → 刷新页面
   ```

### Phase 2: 消费功能
1. **查询服务集成**
   - 简信宝查询
   - 专信宝查询
   - 流水宝查询

2. **消费云函数**
   - `createConsumptionOrder` - 创建消费订单
   - `executeQuery` - 执行查询服务
   - `completeOrder` - 完成订单

3. **消费流程**
   ```
   选择服务 → 检查余额 → 创建订单 → 扣除余额 → 执行查询 → 返回结果
   ```

### Phase 3: 高级功能
1. **余额预警**
   - 余额不足提醒
   - 自动充值建议

2. **交易记录**
   - 详细交易历史
   - 导出功能

3. **会员权益**
   - 会员折扣
   - 积分系统

## 📋 数据库字段设计

### users 表字段（按新设计更新）：
```javascript
{
  // 基础信息
  openid: String,               // 微信用户唯一标识
  unionid: String,              // 微信开放平台唯一标识
  nickName: String,             // 用户昵称
  avatarUrl: String,            // 头像URL

  // 实名认证
  realNameVerified: Boolean,    // 是否实名认证
  realName: String,             // 真实姓名
  idCard: String,               // 身份证号（加密存储）
  phone: String,                // 手机号

  // 余额相关
  balance: Number,              // 当前余额
  totalRecharge: Number,        // 总充值金额
  totalConsumption: Number,     // 总消费金额

  // 企业关联
  organizationId: String,       // 所属企业ID
  organizationName: String,     // 所属企业名称

  // 其他
  memberLevel: String,          // 会员等级
  status: String,               // 用户状态
  createdAt: Date,              // 创建时间
  lastLoginAt: Date             // 最后登录时间
}
```

### organizations 表字段（按新设计更新）：
```javascript
{
  name: String,                 // 企业名称
  code: String,                 // 企业代码
  type: String,                 // 类型（统一为 'company'）
  description: String,          // 企业描述
  legalPerson: String,          // 法人代表
  businessLicense: String,      // 营业执照号
  contactPhone: String,         // 联系电话
  contactEmail: String,         // 联系邮箱
  address: String,              // 企业地址
  adminUsers: Array,            // 管理员用户列表
  coinPrice: Number,            // 资信币价格
  status: String,               // 状态
  sort: Number,                 // 排序
  isDefault: Boolean,           // 是否为默认企业
  createdAt: Date,              // 创建时间
  approvedAt: Date,             // 审核通过时间
  approvedBy: String            // 审核人
}
```

### company_admins 表字段（新增）：
```javascript
{
  username: String,             // 管理员用户名
  password: String,             // 密码（加密存储）
  organizationId: String,       // 所属企业ID
  organizationName: String,     // 所属企业名称
  permissions: Array,           // 权限列表
  status: String,               // 状态
  createdAt: Date,              // 创建时间
  lastLoginAt: Date             // 最后登录时间
}
```

### recharge_records 表：
```javascript
{
  userId: String,               // 用户ID
  rechargeNo: String,           // 充值单号
  amount: Number,               // 充值金额
  status: String,               // 状态：pending/completed/failed
  paymentMethod: String,        // 支付方式
  transactionId: String,        // 交易ID
  createdAt: Date,              // 创建时间
  completedAt: Date             // 完成时间
}
```

### orders 表：
```javascript
{
  userId: String,               // 用户ID
  orderNo: String,              // 订单号
  productName: String,          // 产品名称
  amount: Number,               // 订单金额
  status: String,               // 状态：processing/completed/failed
  queryParams: Object,          // 查询参数
  resultData: Object,           // 查询结果
  createdAt: Date,              // 创建时间
  completedAt: Date             // 完成时间
}
```

## 🔒 安全考虑

1. **并发控制**
   - 使用数据库事务
   - 乐观锁机制
   - 余额版本号

2. **数据校验**
   - 金额范围检查
   - 余额充足性验证
   - 重复提交防护

3. **日志记录**
   - 所有余额变动记录
   - 异常情况告警
   - 审计日志

## 📈 监控指标

1. **业务指标**
   - 充值成功率
   - 消费成功率
   - 余额一致性

2. **技术指标**
   - 接口响应时间
   - 错误率
   - 并发处理能力

## 🎯 当前状态

✅ **已完成**：
- 余额显示统一（使用 users.balance）
- 数据一致性检查
- 同步余额功能
- 交易记录查询

🔄 **进行中**：
- 数据源统一优化

📋 **待实现**：
- 充值功能
- 消费功能
- 支付集成
- 高级功能
