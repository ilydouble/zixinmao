# 资信猫管理端设计文档

## 1. 产品概述

### 1.1 产品定位
资信猫管理端是一个独立的Web管理平台，为超级管理员和企业管理员提供用户管理、数据统计、系统配置等功能。

### 1.2 目标用户
- **超级管理员 (root)**: 系统运营人员，拥有最高权限
- **企业管理员 (companyAdmin)**: 企业用户管理人员，只能管理本企业数据

### 1.3 技术架构
- **前端**: Vue 3 + Element Plus + TypeScript
- **后端**: Node.js + Express + 微信云开发
- **数据库**: 微信云数据库
- **部署**: 云托管 / 独立服务器

## 4. 认证设计

### 4.1 Root 管理员认证
```javascript
// 环境变量或配置文件中设置
const ROOT_CONFIG = {
  username: 'root',
  password: 'your_secure_password_hash', // 加密后的密码
  permissions: ['*'] // 所有权限
}

// 登录验证逻辑
function validateRootLogin(username, password) {
  if (username === 'root') {
    return bcrypt.compare(password, ROOT_CONFIG.password)
  }
  return false
}
```

### 4.2 企业管理员认证
使用现有的 `company_admins` 表：

```javascript
// 现有的 company_admins 表结构
{
  _id: "管理员ID",
  username: "管理员账号",
  password: "加密密码",
  organizationId: "关联企业ID",
  organizationName: "关联企业名称",
  permissions: [], // 权限列表
  status: "active", // 账户状态
  createdAt: "创建时间",
  lastLoginAt: "最后登录时间"
}

// 企业管理员登录验证
async function validateCompanyAdminLogin(username, password) {
  const admin = await db.collection('company_admins')
    .where({ username, status: 'active' })
    .get()
  
  if (admin.data.length > 0) {
    return bcrypt.compare(password, admin.data[0].password)
  }
  return false
}
```

## 5. API 接口设计

### 5.1 认证接口
```javascript
// 统一登录接口
POST /api/admin/login
{
  username: "admin", // root 或企业管理员用户名
  password: "password",
  captcha: "验证码"
}

// 登录响应
{
  success: true,
  data: {
    token: "jwt_token",
    user: {
      id: "user_id",
      username: "admin",
      role: "root" | "company_admin",
      organizationId: "org_id", // 仅企业管理员有此字段
      organizationName: "企业名称", // 仅企业管理员有此字段
      permissions: ["user_management", "price_setting"]
    }
  }
}

// 获取当前用户信息
GET /api/admin/profile

// 退出登录
POST /api/admin/logout
```

### 5.2 权限验证中间件
```javascript
// 认证中间件
async function authenticate(req, res, next) {
  const token = req.headers.authorization?.replace('Bearer ', '')
  
  if (!token) {
    return res.status(401).json({ error: '未登录' })
  }
  
  try {
    const decoded = jwt.verify(token, JWT_SECRET)
    
    if (decoded.role === 'root') {
      // Root 管理员
      req.user = {
        id: 'root',
        username: 'root',
        role: 'root',
        permissions: ['*']
      }
    } else {
      // 企业管理员，从数据库获取最新信息
      const admin = await db.collection('company_admins')
        .doc(decoded.id)
        .get()
      
      if (!admin.data || admin.data.status !== 'active') {
        return res.status(401).json({ error: '账户已禁用' })
      }
      
      req.user = {
        id: admin.data._id,
        username: admin.data.username,
        role: 'company_admin',
        organizationId: admin.data.organizationId,
        organizationName: admin.data.organizationName,
        permissions: admin.data.permissions
      }
    }
    
    next()
  } catch (error) {
    return res.status(401).json({ error: 'Token无效' })
  }
}

// 角色验证
function requireRole(roles) {
  return (req, res, next) => {
    const userRole = req.user.role
    if (!roles.includes(userRole)) {
      return res.status(403).json({ error: '权限不足' })
    }
    next()
  }
}

// 企业数据访问验证
function requireOrgAccess(req, res, next) {
  const { role, organizationId } = req.user
  const targetOrgId = req.params.organizationId || req.query.organizationId
  
  if (role === 'root') {
    return next() // Root 管理员可访问所有数据
  }
  
  if (role === 'company_admin' && organizationId === targetOrgId) {
    return next() // 企业管理员只能访问本企业数据
  }
  
  return res.status(403).json({ error: '无权访问该企业数据' })
}
```

### 5.3 企业管理员管理接口 (仅Root)
```javascript
// 创建企业管理员
POST /api/admin/company-admins
{
  username: "company_admin_001",
  password: "password",
  organizationId: "org_id",
  permissions: ["user_management", "price_setting"]
}

// 获取企业管理员列表
GET /api/admin/company-admins?organizationId=xxx

// 更新企业管理员
PUT /api/admin/company-admins/:id
{
  permissions: ["user_management"],
  status: "active"
}

// 重置企业管理员密码
POST /api/admin/company-admins/:id/reset-password
{
  newPassword: "new_password"
}

// 删除企业管理员
DELETE /api/admin/company-admins/:id
```

## 6. 数据库设计

### 6.1 使用现有表结构

#### company_admins 表 (已存在)
```javascript
{
  _id: "管理员ID",
  username: "管理员账号",
  password: "加密密码",
  organizationId: "关联企业ID", // 关联 organizations._id
  organizationName: "关联企业名称",
  permissions: [], // 权限列表: ["user_management", "price_setting", "data_statistics"]
  status: "active", // 账户状态: active/disabled
  createdAt: "创建时间",
  lastLoginAt: "最后登录时间"
}
```

#### 新增操作日志表 (admin_logs)
```javascript
{
  _id: "日志ID",
  adminId: "管理员ID", // root 或 company_admin ID
  adminUsername: "管理员用户名",
  adminRole: "管理员角色", // root/company_admin
  organizationId: "企业ID", // 仅企业管理员操作时有值
  action: "操作类型", // login/create_user/update_price/approve_enterprise
  module: "功能模块", // user/enterprise/system/price
  target: "操作对象", // user_id/enterprise_id
  details: "操作详情",
  ipAddress: "IP地址",
  userAgent: "用户代理",
  result: "操作结果", // success/failed
  createdAt: "操作时间"
}
```

#### 系统配置表 (system_config)
```javascript
{
  _id: "配置ID",
  key: "配置键", // root_password/base_price_jianxin/base_price_zhuanxin
  value: "配置值",
  type: "数据类型", // string/number/boolean/json
  description: "配置描述",
  category: "配置分类", // auth/price/system
  updatedBy: "更新人", // root 或管理员ID
  updatedAt: "更新时间"
}
```

### 6.2 Root 密码管理
```javascript
// 在 system_config 表中存储 root 密码
{
  key: "root_password",
  value: "$2b$10$encrypted_password_hash",
  type: "string",
  description: "Root管理员密码",
  category: "auth",
  updatedBy: "system",
  updatedAt: new Date()
}

// 修改 root 密码的接口
PUT /api/admin/root/password
{
  currentPassword: "current_password",
  newPassword: "new_password"
}
```

## 7. 权限控制

### 7.1 权限定义
```javascript
const PERMISSIONS = {
  // 用户管理权限
  USER_MANAGEMENT: 'user_management',
  USER_VIEW: 'user_view',
  USER_EDIT: 'user_edit',
  
  // 价格设置权限
  PRICE_SETTING: 'price_setting',
  
  // 数据统计权限
  DATA_STATISTICS: 'data_statistics',
  
  // 企业管理权限 (仅Root)
  ENTERPRISE_MANAGEMENT: 'enterprise_management',
  ENTERPRISE_APPROVAL: 'enterprise_approval',
  
  // 系统配置权限 (仅Root)
  SYSTEM_CONFIG: 'system_config',
  
  // 管理员管理权限 (仅Root)
  ADMIN_MANAGEMENT: 'admin_management'
}

// Root 管理员默认拥有所有权限
const ROOT_PERMISSIONS = ['*']

// 企业管理员默认权限
const DEFAULT_COMPANY_ADMIN_PERMISSIONS = [
  'user_management',
  'price_setting', 
  'data_statistics'
]
```

### 7.2 权限验证函数
```javascript
function hasPermission(user, permission) {
  if (user.role === 'root') {
    return true // Root 拥有所有权限
  }
  
  return user.permissions.includes(permission)
}

// 权限验证中间件
function requirePermission(permission) {
  return (req, res, next) => {
    if (!hasPermission(req.user, permission)) {
      return res.status(403).json({ error: '权限不足' })
    }
    next()
  }
}
```

## 8. 登录流程

### 8.1 统一登录处理
```javascript
// 登录接口实现
app.post('/api/admin/login', async (req, res) => {
  const { username, password, captcha } = req.body
  
  try {
    // 验证验证码
    if (!validateCaptcha(captcha)) {
      return res.status(400).json({ error: '验证码错误' })
    }
    
    let user = null
    
    if (username === 'root') {
      // Root 管理员登录
      const rootPassword = await getSystemConfig('root_password')
      const isValid = await bcrypt.compare(password, rootPassword)
      
      if (isValid) {
        user = {
          id: 'root',
          username: 'root',
          role: 'root',
          permissions: ['*']
        }
      }
    } else {
      // 企业管理员登录
      const admin = await db.collection('company_admins')
        .where({ username, status: 'active' })
        .get()
      
      if (admin.data.length > 0) {
        const adminData = admin.data[0]
        const isValid = await bcrypt.compare(password, adminData.password)
        
        if (isValid) {
          user = {
            id: adminData._id,
            username: adminData.username,
            role: 'company_admin',
            organizationId: adminData.organizationId,
            organizationName: adminData.organizationName,
            permissions: adminData.permissions
          }
          
          // 更新最后登录时间
          await db.collection('company_admins').doc(adminData._id).update({
            data: { lastLoginAt: new Date() }
          })
        }
      }
    }
    
    if (!user) {
      return res.status(401).json({ error: '用户名或密码错误' })
    }
    
    // 生成 JWT Token
    const token = jwt.sign(
      { id: user.id, role: user.role },
      JWT_SECRET,
      { expiresIn: '24h' }
    )
    
    // 记录登录日志
    await logAdminAction({
      adminId: user.id,
      adminUsername: user.username,
      adminRole: user.role,
      organizationId: user.organizationId,
      action: 'login',
      module: 'auth',
      details: '管理员登录',
      ipAddress: req.ip,
      userAgent: req.get('User-Agent'),
      result: 'success'
    })
    
    res.json({
      success: true,
      data: { token, user }
    })
    
  } catch (error) {
    console.error('登录失败:', error)
    res.status(500).json({ error: '登录失败' })
  }
})
```

## 9. 初始化脚本

### 9.1 Root 密码初始化
```javascript
// 在 initDatabase 云函数中添加
async function initRootPassword() {
  const existingConfig = await db.collection('system_config')
    .where({ key: 'root_password' })
    .get()
  
  if (existingConfig.data.length === 0) {
    const defaultPassword = 'admin123456' // 默认密码，部署后需要修改
    const hashedPassword = await bcrypt.hash(defaultPassword, 10)
    
    await db.collection('system_config').add({
      data: {
        key: 'root_password',
        value: hashedPassword,
        type: 'string',
        description: 'Root管理员密码',
        category: 'auth',
        updatedBy: 'system',
        updatedAt: new Date()
      }
    })
    
    console.log('Root 密码初始化完成，默认密码: admin123456')
  }
}
```

### 9.2 企业管理员初始化
```javascript
// 为根企业创建默认管理员
async function initDefaultCompanyAdmin() {
  const rootOrg = await db.collection('organizations')
    .where({ isDefault: true })
    .get()
  
  if (rootOrg.data.length > 0) {
    const orgData = rootOrg.data[0]
    
    const existingAdmin = await db.collection('company_admins')
      .where({ organizationId: orgData._id })
      .get()
    
    if (existingAdmin.data.length === 0) {
      const defaultPassword = await bcrypt.hash('admin123456', 10)
      
      await db.collection('company_admins').add({
        data: {
          username: 'haiyuan_admin',
          password: defaultPassword,
          organizationId: orgData._id,
          organizationName: orgData.name,
          permissions: ['user_management', 'price_setting', 'data_statistics'],
          status: 'active',
          createdAt: new Date(),
          lastLoginAt: null
        }
      })
      
      console.log('默认企业管理员创建完成')
    }
  }
}
```

## 10. 安全注意事项

### 10.1 密码安全
- Root 密码必须在部署后立即修改
- 所有密码使用 bcrypt 加密存储
- 密码复杂度要求：至少8位，包含大小写字母和数字

### 10.2 会话安全
- JWT Token 有效期设置为24小时
- 敏感操作需要重新验证身份
- 定期清理过期的登录会话

### 10.3 操作审计
- 所有管理操作必须记录日志
- 日志包含操作人、时间、内容、结果
- 定期备份和归档日志数据

这样的设计复用了现有的 `company_admins` 表，Root 管理员通过配置文件或环境变量管理，更加简洁高效。