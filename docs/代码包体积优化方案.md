# 代码包体积优化方案

## 优化目标

解决微信小程序代码包体积超限问题：
1. 代码包不包含插件大小超过 1.5 M
2. 引用插件大小超过 200 K
3. 图片和音频资源大小超过 200 K

## 优化措施

### 1. 删除未使用的测试页面 ✅

**删除的文件：**
- `miniprogram/pages/debug/` - 调试工具页面
- `miniprogram/pages/font-test/` - 字体测试页面

**效果：**
- 减少了不必要的页面代码
- 清理了开发测试相关的功能

### 2. 优化图片资源 ✅

**问题图片：**
- `banner1.png` - 173K
- `banner2.png` - 337K ⚠️ 超过200K
- `banner3.png` - 283K ⚠️ 超过200K

**优化方案：**
- 使用 CSS 渐变背景替代大图片
- 删除了 3 个 banner 图片文件
- 节省了约 793K 的空间

### 2.5. 删除本地字体文件 ✅

**问题字体：**
- `fonts/t.svg` - 2.6M ⚠️⚠️⚠️ 严重超标！
- `fonts/t.ttf` - 361K ⚠️ 超过200K
- `fonts/t.eot` - 361K ⚠️ 超过200K
- `fonts/t.woff` - 161K

**优化方案：**
- 删除所有本地 TDesign 字体文件
- 使用 CDN 动态加载字体（已在 fontManager.ts 中配置）
- 节省了约 3.5M 的空间！

**CDN 字体加载：**
```typescript
// fontManager.ts 已配置从 CDN 加载
const fontSources = [
  {
    url: 'https://tdesign.gtimg.com/icon/0.3.2/fonts/t.woff',
    format: 'WOFF'
  },
  {
    url: 'https://tdesign.gtimg.com/icon/0.3.2/fonts/t.ttf',
    format: 'TTF'
  }
]
```

**实现方式：**
```typescript
// home.ts
banners: [
  {
    id: 1,
    title: '流水宝',
    bgColor: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    link: '/packageBusiness/pages/liushui/liushui',
    disabled: true
  },
  // ...
]
```

```css
/* home.wxss */
.banner-bg {
  width: 100%;
  height: 100%;
  border-radius: 16rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40rpx;
}
```

### 3. 配置分包加载 ✅

**分包策略：**

#### 主包（Main Package）
保留核心页面和 tabBar 页面：
- `pages/index/index` - 入口页
- `pages/home/home` - 首页（tabBar）
- `pages/login/login` - 登录页
- `pages/auth/auth` - 实名认证页
- `pages/center/center` - 个人中心（tabBar）

**主包大小：** 约 128K

#### 分包1：业务功能包（packageBusiness）
包含所有业务分析功能：
- `pages/liushui/liushui` - 流水宝
- `pages/jianxin/jianxin` - 简信宝
- `pages/zhuanxin/zhuanxin` - 专信宝
- `pages/report/report` - 报告页面
- `pages/report-native/report-native` - 原生报告页面

**分包大小：** 约 220K

#### 分包2：用户服务包（packageUser）
包含用户相关功能：
- `pages/orders/orders` - 个人订单
- `pages/recharge/recharge` - 会员充值
- `pages/balance/balance` - 我的余额
- `pages/support/support` - 联系客服
- `pages/help/help` - 帮助中心
- `pages/settings/settings` - 设置
- `pages/product-detail/product-detail` - 产品详情

**分包大小：** 约 116K

**配置代码：**
```json
{
  "pages": [
    "pages/index/index",
    "pages/home/home",
    "pages/login/login",
    "pages/auth/auth",
    "pages/center/center"
  ],
  "subpackages": [
    {
      "root": "packageBusiness",
      "name": "business",
      "pages": [
        "pages/liushui/liushui",
        "pages/jianxin/jianxin",
        "pages/zhuanxin/zhuanxin",
        "pages/report/report",
        "pages/report-native/report-native"
      ]
    },
    {
      "root": "packageUser",
      "name": "user",
      "pages": [
        "pages/orders/orders",
        "pages/recharge/recharge",
        "pages/balance/balance",
        "pages/support/support",
        "pages/help/help",
        "pages/settings/settings",
        "pages/product-detail/product-detail"
      ]
    }
  ]
}
```

**路径更新：**
所有跳转路径已更新为分包路径，例如：
- `/pages/jianxin/jianxin` → `/packageBusiness/pages/jianxin/jianxin`
- `/pages/orders/orders` → `/packageUser/pages/orders/orders`

### 4. 优化 TDesign 组件引用 ✅

**优化措施：**
- 使用相对路径引用组件，减少路径长度
- 保留 `lazyCodeLoading: "requiredComponents"` 配置
- 让小程序自动按需加载组件

**优化前：**
```json
{
  "usingComponents": {
    "t-button": "/miniprogram_npm/tdesign-miniprogram/button/button",
    "t-cell": "/miniprogram_npm/tdesign-miniprogram/cell/cell"
  }
}
```

**优化后：**
```json
{
  "lazyCodeLoading": "requiredComponents",
  "usingComponents": {
    "t-button": "tdesign-miniprogram/button/button",
    "t-cell": "tdesign-miniprogram/cell/cell"
  }
}
```

使用相对路径，配合 `lazyCodeLoading` 实现按需加载。

## 优化效果总结

### 体积对比

| 项目 | 优化前 | 优化后 | 节省 |
|------|--------|--------|------|
| 图片资源 | ~950K | ~180K | ~770K |
| 字体文件 | ~3.5M | 0K (CDN加载) | ~3.5M ⭐ |
| 主包页面 | 全部页面 | 5个核心页面 | 大幅减少 |
| 分包1（业务） | - | 220K | 按需加载 |
| 分包2（用户） | - | 116K | 按需加载 |

### 关键优化点

1. **字体优化：** 删除本地字体文件，使用 CDN 加载，节省 ~3.5M ⭐⭐⭐
2. **图片优化：** 删除 3 个大图片，使用 CSS 渐变替代，节省 ~770K
3. **分包加载：** 主包只保留核心页面，其他页面按需加载
4. **组件优化：** 启用按需加载，减少首次加载体积
5. **代码清理：** 删除测试页面和未使用的代码

### 预期效果

- ✅ 主包体积大幅降低（< 500K）
- ✅ 图片资源全部 < 200K
- ✅ 分包按需加载，提升首屏加载速度
- ✅ 符合微信小程序代码包规范

## 后续建议

### 1. 图片资源管理
- 所有超过 100K 的图片都应该上传到云存储
- 使用 CDN 链接引用图片
- 考虑使用 WebP 格式进一步压缩

### 2. 代码优化
- 定期清理未使用的代码和资源
- 使用代码分割和懒加载
- 压缩和混淆代码

### 3. 分包策略
- 根据功能模块合理划分分包
- 控制每个分包大小 < 2M
- 主包 + 所有分包总大小 < 20M

### 4. 性能监控
- 定期检查代码包大小
- 监控首屏加载时间
- 优化用户体验

## 注意事项

1. **路径更新：** 所有页面跳转路径已更新为分包路径
2. **组件引用：** 各页面需要在自己的 json 文件中引入所需组件
3. **测试验证：** 需要全面测试所有页面跳转和功能
4. **云存储：** 后续可以将更多静态资源迁移到云存储

## 测试清单

- [ ] 首页 banner 显示正常
- [ ] 所有页面跳转正常
- [ ] 分包页面加载正常
- [ ] TDesign 组件显示正常
- [ ] 功能测试通过
- [ ] 代码包大小符合要求

