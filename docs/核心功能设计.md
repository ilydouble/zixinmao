# 资信猫核心功能设计文档

## 1. 功能概述

### 1.1 核心功能模块
- **流水宝**: 银行流水智能分析
- **简信宝**: 简版征信报告解读  
- **专信宝**: 详版征信报告专业分析

### 1.2 技术架构
```
用户上传 → 文件验证 → 云存储 → 异步分析 → 进度通知 → 报告生成 → 结果展示
```

### 1.3 异步处理机制
- **立即响应**: 文件上传后立即返回任务ID
- **后台处理**: 云函数异步执行分析任务
- **实时通知**: 通过数据库监听推送进度更新
- **状态同步**: 前端轮询或监听获取最新状态

## 2. 文件处理流程

### 2.1 文件上传验证
```javascript
// 支持的文件格式
const SUPPORTED_FORMATS = {
  'flow': ['.pdf', '.jpg', '.jpeg', '.png'],     // 流水宝
  'simple': ['.pdf'],                            // 简信宝
  'detail': ['.pdf']                             // 专信宝
}

// 统一文件大小限制：10MB
const FILE_SIZE_LIMIT = 10 * 1024 * 1024  // 10MB
```

### 2.2 文件验证规则
- **格式检查**: 文件扩展名 + MIME类型双重验证
- **大小检查**: 统一限制文件大小不超过10MB
- **内容检查**: PDF文件完整性验证
- **安全检查**: 恶意文件扫描

### 2.3 云存储结构
```
cloud://zixinmao-6gze9a8pef07503b.7a69-zixinmao-6gze9a8pef07503b-1329/
├── uploads/
│   ├── flow/           # 流水宝上传文件
│   │   └── {userId}/
│   │       └── {timestamp}_{filename}
│   ├── simple/         # 简信宝上传文件
│   │   └── {userId}/
│   │       └── {timestamp}_{filename}
│   └── detail/         # 专信宝上传文件
│       └── {userId}/
│           └── {timestamp}_{filename}
└── reports/
    ├── flow/           # 流水宝生成报告
    ├── simple/         # 简信宝生成报告
    └── detail/         # 专信宝生成报告
```

## 3. 异步处理架构

### 3.1 处理流程设计
```
1. 文件上传 (同步) → 返回 reportId
2. 创建任务记录 (同步) → 状态: pending
3. 触发异步分析 (异步) → 状态: processing
4. 算法接口调用 (异步) → 更新进度
5. 报告生成 (异步) → 状态: completed
6. 前端通知 (实时) → 用户查看结果
```

### 3.2 状态管理
```javascript
// 报告处理状态
const REPORT_STATUS = {
  PENDING: 'pending',           // 等待处理
  UPLOADING: 'uploading',       // 文件上传中
  PROCESSING: 'processing',     // 分析处理中
  COMPLETED: 'completed',       // 处理完成
  FAILED: 'failed'             // 处理失败
}

// 进度阶段定义
const PROGRESS_STAGES = {
  FILE_UPLOAD: { start: 0, end: 15, desc: '文件上传中' },
  FILE_PARSE: { start: 15, end: 35, desc: '文件解析中' },
  DATA_EXTRACT: { start: 35, end: 55, desc: '数据提取中' },
  AI_ANALYSIS: { start: 55, end: 85, desc: '智能分析中' },
  REPORT_GENERATE: { start: 85, end: 95, desc: '报告生成中' },
  QUALITY_CHECK: { start: 95, end: 100, desc: '质量检查中' }
}
```

### 3.3 实时通知机制
```javascript
// 前端监听数据库变化
const watchReportProgress = (reportId) => {
  const db = wx.cloud.database()
  
  return db.collection('reports').doc(reportId).watch({
    onChange: (snapshot) => {
      const report = snapshot.docs[0]
      if (report) {
        updateProgressUI(report.processing)
        
        // 处理完成时的通知
        if (report.processing.status === 'completed') {
          showCompletionNotification(report)
        }
      }
    },
    onError: (err) => {
      console.error('监听报告进度失败:', err)
    }
  })
}

// 进度更新UI
const updateProgressUI = (processing) => {
  const { status, progress, currentStage } = processing
  
  // 更新进度条
  this.setData({
    progress: progress,
    statusText: getStatusText(status, currentStage),
    estimatedTime: calculateEstimatedTime(progress)
  })
}
```

## 4. 算法接口设计

### 4.1 接口规范
```javascript
// 统一的算法调用接口
const ALGORITHM_API = {
  baseUrl: 'https://api.algorithm.com/v1',
  endpoints: {
    flow: '/analyze/bankflow',
    simple: '/analyze/credit-simple', 
    detail: '/analyze/credit-detail'
  },
  timeout: 300000,  // 5分钟超时
  retryTimes: 3     // 重试次数
}
```

### 4.2 异步调用设计
```javascript
// 异步算法调用
async function callAlgorithmAPI(params) {
  const { reportId, fileUrl, analysisType, prompt } = params
  
  try {
    // 更新状态：开始调用算法
    await updateReportProgress(reportId, 55, 'AI_ANALYSIS')
    
    // 调用算法接口
    const response = await fetch(ALGORITHM_API.baseUrl + ALGORITHM_API.endpoints[analysisType], {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${getAPIToken()}`
      },
      body: JSON.stringify({
        fileUrl: fileUrl,
        prompt: prompt,
        callbackUrl: `${getCallbackUrl()}/algorithm-callback`,
        requestId: generateRequestId()
      }),
      timeout: ALGORITHM_API.timeout
    })
    
    const result = await response.json()
    
    if (result.success) {
      // 更新进度：算法分析完成
      await updateReportProgress(reportId, 85, 'REPORT_GENERATE')
      return result.data
    } else {
      throw new Error(result.message || '算法分析失败')
    }
    
  } catch (error) {
    console.error('算法调用失败:', error)
    await updateReportStatus(reportId, 'failed', error.message)
    throw error
  }
}
```

### 4.3 回调处理机制
```javascript
// 算法回调处理 (如果算法支持回调)
exports.algorithmCallback = async (event, context) => {
  const { requestId, status, data, error } = event
  
  try {
    // 根据requestId找到对应的报告
    const report = await findReportByRequestId(requestId)
    if (!report) {
      throw new Error('报告记录不存在')
    }
    
    if (status === 'success') {
      // 处理成功结果
      await processAnalysisResult(report._id, data)
    } else {
      // 处理失败
      await updateReportStatus(report._id, 'failed', error)
    }
    
    return { success: true }
  } catch (error) {
    console.error('回调处理失败:', error)
    return { success: false, error: error.message }
  }
}
```

## 5. 数据库设计

### 5.1 reports 表结构
```javascript
{
  _id: "report_xxx",
  userId: "user_openid_123",
  reportType: "flow|simple|detail",
  
  // 输入信息
  input: {
    originalFileName: "银行流水.pdf",
    fileSize: 2048576,
    uploadTime: "2024-12-01T10:00:00.000Z",
    cloudPath: "cloud://xxx/uploads/flow/user123/1703123456_流水.pdf"
  },
  
  // 处理信息
  processing: {
    status: "pending|uploading|processing|completed|failed",
    progress: 0,
    currentStage: "FILE_UPLOAD",
    startTime: "2024-12-01T10:01:00.000Z",
    endTime: null,
    processingTime: null,
    errorMessage: null,
    estimatedTimeRemaining: 180  // 预估剩余时间(秒)
  },
  
  // 算法调用信息
  algorithm: {
    requestId: "req_1703123456789",
    apiEndpoint: "/analyze/bankflow",
    prompt: "分析提示词...",
    requestTime: "2024-12-01T10:01:00.000Z",
    responseTime: null,
    retryCount: 0
  },
  
  // 输出结果
  output: {
    // 报告文件存储
    reportFiles: {
      jsonUrl: "cloud://xxx/reports/flow/report_xxx.json",      // JSON格式报告
      pdfUrl: "cloud://xxx/reports/flow/report_xxx.pdf",        // PDF格式报告
      htmlUrl: "cloud://xxx/reports/flow/report_xxx.html"       // HTML格式报告(可选)
    },
    
    // 快速摘要信息(用于列表展示)
    summary: {
      totalIncome: 50000.00,
      totalExpense: 35000.00,
      analysisScore: 85,
      riskLevel: "低风险",
      reportTitle: "银行流水分析报告",
      generateTime: "2024-12-01T10:05:30.000Z"
    },
    
    // 文件元信息
    fileInfo: {
      jsonFileSize: 245760,    // JSON文件大小
      pdfFileSize: 1048576,    // PDF文件大小
      downloadCount: 0,        // 下载次数
      lastDownloadTime: null   // 最后下载时间
    }
  },
  
  // 元数据
  metadata: {
    createdAt: "2024-12-01T10:00:00.000Z",
    updatedAt: "2024-12-01T10:03:30.000Z",
    version: "1.0",
    tags: ["银行流水", "收支分析"],
    expiresAt: "2024-12-08T10:00:00.000Z"  // 报告过期时间
  }
}
```

### 5.2 任务队列表 (可选)
```javascript
// tasks 表 - 用于管理异步任务
{
  _id: "task_xxx",
  reportId: "report_xxx",
  taskType: "analyze_report",
  status: "pending|processing|completed|failed",
  priority: 1,  // 任务优先级
  attempts: 0,  // 尝试次数
  maxAttempts: 3,
  scheduledTime: "2024-12-01T10:01:00.000Z",
  startTime: null,
  endTime: null,
  errorMessage: null,
  createdAt: "2024-12-01T10:00:00.000Z"
}
```

## 6. 报告文件存储设计

### 6.1 云存储目录结构
```
cloud://zixinmao-6gze9a8pef07503b.7a69-zixinmao-6gze9a8pef07503b-1329/
├── uploads/                    # 用户上传文件
│   ├── flow/                  # 流水宝上传文件
│   │   └── {userId}/
│   │       └── {timestamp}_{filename}
│   ├── simple/                # 简信宝上传文件
│   │   └── {userId}/
│   │       └── {timestamp}_{filename}
│   └── detail/                # 专信宝上传文件
│       └── {userId}/
│           └── {timestamp}_{filename}
├── reports/                   # 生成的报告文件
│   ├── flow/                  # 流水宝报告
│   │   └── {userId}/
│   │       ├── {reportId}.json      # JSON格式报告数据
│   │       ├── {reportId}.pdf       # PDF格式报告文件
│   │       └── {reportId}.html      # HTML格式报告(可选)
│   ├── simple/                # 简信宝报告
│   │   └── {userId}/
│   │       ├── {reportId}.json
│   │       ├── {reportId}.pdf
│   │       └── {reportId}.html
│   └── detail/                # 专信宝报告
│       └── {userId}/
│           ├── {reportId}.json
│           ├── {reportId}.pdf
│           └── {reportId}.html
└── temp/                      # 临时文件
    └── {timestamp}/
```

### 6.2 报告文件格式规范

#### 6.2.1 JSON格式报告 (用于小程序渲染)
```javascript
// 流水宝报告JSON结构
{
  "reportInfo": {
    "reportId": "report_xxx",
    "reportType": "flow",
    "title": "银行流水分析报告",
    "generateTime": "2024-12-01T10:05:30.000Z",
    "version": "1.0",
    "bankName": "中国工商银行",
    "accountType": "储蓄卡",
    "analysisTimeRange": {
      "startDate": "2024-01-01",
      "endDate": "2024-11-30",
      "totalDays": 334
    }
  },
  
  "summary": {
    "overallScore": 85,
    "riskLevel": "低风险",
    "totalIncome": 156800.00,
    "totalExpense": 98600.00,
    "netFlow": 58200.00,
    "avgMonthlyIncome": 14254.55,
    "avgMonthlyExpense": 8963.64,
    "transactionCount": 286,
    "balanceStability": "稳定"
  },
  
  "incomeAnalysis": {
    "totalAmount": 156800.00,
    "monthlyTrend": [
      { "month": "2024-01", "amount": 12500.00 },
      { "month": "2024-02", "amount": 13200.00 },
      // ... 其他月份
    ],
    "sourceBreakdown": [
      { "type": "工资收入", "amount": 120000.00, "percentage": 76.5, "color": "#4CAF50" },
      { "type": "投资收益", "amount": 25000.00, "percentage": 15.9, "color": "#2196F3" },
      { "type": "其他收入", "amount": 11800.00, "percentage": 7.6, "color": "#FF9800" }
    ],
    "stabilityScore": 92,
    "regularityAnalysis": "收入规律性良好，每月固定时间有工资入账"
  },
  
  "expenseAnalysis": {
    "totalAmount": 98600.00,
    "monthlyTrend": [
      { "month": "2024-01", "amount": 8500.00 },
      { "month": "2024-02", "amount": 9200.00 },
      // ... 其他月份
    ],
    "categoryBreakdown": [
      { "type": "生活消费", "amount": 45000.00, "percentage": 45.6, "color": "#E91E63" },
      { "type": "房贷还款", "amount": 28000.00, "percentage": 28.4, "color": "#9C27B0" },
      { "type": "投资理财", "amount": 15000.00, "percentage": 15.2, "color": "#3F51B5" },
      { "type": "其他支出", "amount": 10600.00, "percentage": 10.8, "color": "#607D8B" }
    ],
    "consumptionHabits": "消费习惯良好，支出结构合理"
  },
  
  "balanceAnalysis": {
    "currentBalance": 45600.00,
    "maxBalance": 67800.00,
    "minBalance": 12300.00,
    "avgBalance": 38900.00,
    "balanceFluctuation": "中等",
    "lowBalanceDays": 15,
    "stabilityScore": 78
  },
  
  "transactionBehavior": {
    "totalTransactions": 286,
    "avgDailyTransactions": 2.6,
    "largeTransactions": {
      "count": 12,
      "threshold": 10000.00,
      "totalAmount": 85000.00
    },
    "timePattern": {
      "mostActiveHour": "14:00-15:00",
      "mostActiveDay": "周五",
      "weekdayVsWeekend": "工作日交易更频繁"
    },
    "abnormalTransactions": []
  },
  
  "riskAssessment": {
    "overallRisk": "低风险",
    "riskFactors": [
      {
        "factor": "收入稳定性",
        "level": "低风险",
        "score": 92,
        "description": "收入来源稳定，波动较小"
      },
      {
        "factor": "支出合理性", 
        "level": "低风险",
        "score": 88,
        "description": "支出结构合理，无异常大额支出"
      },
      {
        "factor": "资金流动性",
        "level": "中风险",
        "score": 75,
        "description": "账户余额波动适中，流动性良好"
      }
    ],
    "creditworthiness": {
      "score": 85,
      "level": "良好",
      "repaymentCapacity": "强"
    }
  },
  
  "recommendations": [
    {
      "type": "优化建议",
      "title": "增加储蓄比例",
      "content": "建议将月收入的20%用于储蓄，提高资金安全性",
      "priority": "中"
    },
    {
      "type": "风险提示",
      "title": "关注账户余额",
      "content": "建议保持账户余额不低于3个月支出总额",
      "priority": "高"
    }
  ],
  
  "charts": {
    "incomeExpenseTrend": {
      "type": "line",
      "data": [
        { "month": "2024-01", "income": 12500, "expense": 8500 },
        // ... 其他月份数据
      ]
    },
    "categoryPieChart": {
      "type": "pie", 
      "data": [
        { "name": "工资收入", "value": 120000, "color": "#4CAF50" },
        // ... 其他分类数据
      ]
    }
  }
}

// 简信宝报告JSON结构
{
  "reportInfo": {
    "reportId": "report_xxx",
    "reportType": "simple",
    "title": "简版征信分析报告",
    "generateTime": "2024-12-01T10:05:30.000Z",
    "version": "1.0",
    "reportDate": "2024-11-30",
    "queryReason": "贷前审查"
  },
  
  "personalInfo": {
    "name": "张***",
    "idNumber": "110***********1234",
    "phoneNumber": "138****5678",
    "updateTime": "2024-11-30"
  },
  
  "creditSummary": {
    "overallScore": 78,
    "creditLevel": "良好",
    "totalCreditLimit": 180000.00,
    "usedCreditLimit": 45000.00,
    "utilizationRate": 25.0,
    "totalLoanAmount": 350000.00,
    "remainingLoanAmount": 280000.00
  },
  
  "accountOverview": {
    "creditCards": {
      "totalCount": 5,
      "activeCount": 4,
      "totalLimit": 180000.00,
      "usedAmount": 45000.00,
      "utilizationRate": 25.0,
      "accounts": [
        {
          "bank": "招商银行",
          "cardType": "信用卡",
          "limit": 50000.00,
          "used": 12000.00,
          "status": "正常"
        }
        // ... 其他卡片
      ]
    },
    "loans": {
      "totalCount": 2,
      "activeCount": 2,
      "totalAmount": 350000.00,
      "remainingAmount": 280000.00,
      "accounts": [
        {
          "bank": "中国银行",
          "loanType": "个人住房贷款",
          "originalAmount": 300000.00,
          "remainingAmount": 250000.00,
          "status": "正常"
        }
        // ... 其他贷款
      ]
    }
  },
  
  "paymentHistory": {
    "overallStatus": "正常",
    "overdueRecords": {
      "totalCount": 2,
      "recentOverdue": 0,
      "maxOverdueDays": 15,
      "records": [
        {
          "date": "2024-03-15",
          "account": "招商银行信用卡",
          "overdueDays": 5,
          "overdueAmount": 1200.00,
          "status": "已还清"
        }
      ]
    },
    "paymentPerformance": {
      "onTimeRate": 96.5,
      "score": 85,
      "trend": "稳定"
    }
  },
  
  "queryRecords": {
    "totalQueries": 15,
    "recentQueries": {
      "last6Months": 3,
      "last2Years": 12
    },
    "queryBreakdown": [
      { "type": "贷后管理", "count": 8, "percentage": 53.3 },
      { "type": "信用卡审批", "count": 4, "percentage": 26.7 },
      { "type": "贷款审批", "count": 3, "percentage": 20.0 }
    ],
    "riskLevel": "正常"
  },
  
  "riskAssessment": {
    "overallRisk": "低风险",
    "creditRisk": "低",
    "repaymentRisk": "低", 
    "stabilityRisk": "中",
    "riskFactors": [
      {
        "factor": "信用历史",
        "level": "良好",
        "score": 85,
        "description": "信用记录良好，偶有轻微逾期"
      }
    ]
  },
  
  "recommendations": [
    {
      "type": "信用优化",
      "title": "降低信用卡使用率",
      "content": "建议将信用卡使用率控制在30%以下，有助于提升信用评分",
      "priority": "中"
    },
    {
      "type": "申贷建议",
      "title": "适合申请消费贷款",
      "content": "当前信用状况良好，适合申请利率较低的消费类贷款",
      "priority": "低"
    }
  ]
}

// 专信宝报告JSON结构
{
  "reportInfo": {
    "reportId": "report_xxx", 
    "reportType": "detail",
    "title": "详版征信专业分析报告",
    "generateTime": "2024-12-01T10:05:30.000Z",
    "version": "1.0",
    "reportDate": "2024-11-30",
    "dataSource": "中国人民银行征信中心"
  },
  
  "executiveSummary": {
    "overallScore": 82,
    "creditGrade": "A-",
    "riskLevel": "低风险",
    "keyFindings": [
      "信用历史长度适中，表现良好",
      "当前负债水平合理，还款能力强",
      "查询频次正常，无过度申贷迹象"
    ],
    "recommendations": [
      "继续保持良好的还款记录",
      "适当优化信用卡使用结构"
    ]
  },
  
  // ... 包含更详细的分析维度
  "detailedAnalysis": {
    "creditHistory": {
      "firstAccountDate": "2018-06-15",
      "creditAge": "6年5个月",
      "accountGrowthTrend": "稳步增长",
      "timeline": [
        {
          "date": "2018-06-15",
          "event": "首张信用卡开户",
          "institution": "招商银行"
        }
        // ... 其他重要事件
      ]
    },
    
    "comprehensiveRiskModel": {
      "riskScore": 82,
      "riskFactors": [
        {
          "category": "信用历史",
          "weight": 35,
          "score": 85,
          "impact": "正面"
        },
        {
          "category": "当前负债",
          "weight": 30, 
          "score": 78,
          "impact": "中性"
        }
        // ... 其他风险因子
      ]
    }
  }
}
```

#### 6.2.2 小程序页面渲染设计

**页面结构设计：**
```
报告详情页面
├── 报告头部
│   ├── 报告标题和生成时间
│   ├── 总体评分（大号显示）
│   └── 风险等级标签
├── 核心指标卡片
│   ├── 收支概览（流水宝）
│   ├── 信用概览（征信报告）
│   └── 关键数据可视化
├── 详细分析模块
│   ├── 可折叠的分析维度
│   ├── 图表展示（饼图、折线图）
│   └── 数据表格
├── 风险评估
│   ├── 风险因子列表
│   └── 风险等级说明
└── 专业建议
    ├── 优化建议列表
    └── 注意事项
```

**UI组件设计：**
```javascript
// 评分圆环组件
<score-ring score="{{summary.overallScore}}" />

// 趋势图表组件  
<trend-chart data="{{incomeAnalysis.monthlyTrend}}" />

// 分类饼图组件
<pie-chart data="{{expenseAnalysis.categoryBreakdown}}" />

// 风险标签组件
<risk-tag level="{{riskAssessment.overallRisk}}" />

// 建议卡片组件
<recommendation-card 
  wx:for="{{recommendations}}" 
  wx:key="index"
  data="{{item}}" />
```

### 6.3 文件访问权限设计
```javascript
// 云存储安全规则
{
  "read": "auth.openid == resource.openid || auth.role == 'admin'",
  "write": "auth.openid == resource.openid && auth.role == 'user'"
}

// 临时访问链接生成
async function generateTempDownloadUrl(fileId, expiresIn = 3600) {
  const result = await cloud.getTempFileURL({
    fileList: [fileId],
    maxAge: expiresIn  // 1小时有效期
  })
  
  return result.fileList[0].tempFileURL
}
```

## 7. 云函数设计更新

### 7.1 uploadFile 云函数 (同步)
```javascript
// 文件上传处理 - 立即返回
exports.main = async (event, context) => {
  const { fileBuffer, fileName, reportType } = event
  const { OPENID } = cloud.getWXContext()
  
  try {
    // 1. 文件验证
    const validation = validateFile(fileName, fileBuffer.length, reportType)
    if (!validation.valid) {
      throw new Error(validation.message)
    }
    
    // 2. 创建报告记录
    const reportId = await createReportRecord(OPENID, {
      reportType,
      fileName,
      fileSize: fileBuffer.length,
      status: 'pending'
    })
    
    // 3. 异步上传文件并开始分析
    triggerAsyncAnalysis(reportId, fileBuffer, fileName, reportType)
    
    // 4. 立即返回报告ID
    return {
      success: true,
      reportId: reportId,
      message: '文件上传成功，正在分析中...'
    }
  } catch (error) {
    console.error('文件上传失败:', error)
    throw error
  }
}

// 触发异步分析
async function triggerAsyncAnalysis(reportId, fileBuffer, fileName, reportType) {
  // 调用另一个云函数进行异步处理
  cloud.callFunction({
    name: 'processReportAsync',
    data: {
      reportId,
      fileBuffer,
      fileName,
      reportType
    }
  }).catch(error => {
    console.error('触发异步分析失败:', error)
    updateReportStatus(reportId, 'failed', error.message)
  })
}
```

### 7.2 processReportAsync 云函数 (异步)
```javascript
// 异步报告处理 - 更新版本
exports.main = async (event, context) => {
  const { reportId, fileBuffer, fileName, reportType } = event
  
  try {
    // 1-5. 前期处理步骤保持不变...
    
    // 6. 调用算法接口获取分析结果
    const analysisResult = await callAlgorithmAPI({
      reportId,
      fileUrl: downloadUrl,
      analysisType: reportType,
      prompt: getPromptByType(reportType)
    })
    
    // 7. 更新进度：开始生成报告文件
    await updateReportProgress(reportId, 85, 'REPORT_GENERATE')
    
    // 8. 生成并保存报告文件到云存储
    const reportFiles = await generateAndSaveReportFiles(reportId, reportType, analysisResult)
    
    // 9. 更新进度：质量检查
    await updateReportProgress(reportId, 95, 'QUALITY_CHECK')
    
    // 10. 保存结果并完成
    await updateReportResult(reportId, {
      reportFiles: reportFiles,
      summary: extractSummary(analysisResult),
      fileInfo: {
        jsonFileSize: reportFiles.jsonFileSize,
        pdfFileSize: reportFiles.pdfFileSize,
        downloadCount: 0,
        lastDownloadTime: null
      }
    })
    
    // 11. 标记完成
    await updateReportProgress(reportId, 100, 'COMPLETED')
    
    return { success: true, reportId, reportFiles }
    
  } catch (error) {
    console.error('异步处理失败:', error)
    await updateReportStatus(reportId, 'failed', error.message)
    throw error
  }
}

// 生成并保存报告文件
async function generateAndSaveReportFiles(reportId, reportType, analysisResult) {
  const { OPENID } = cloud.getWXContext()
  
  // 1. 生成JSON报告
  const jsonReport = generateJSONReport(reportId, reportType, analysisResult)
  const jsonBuffer = Buffer.from(JSON.stringify(jsonReport, null, 2), 'utf8')
  
  // 2. 生成PDF报告
  const pdfBuffer = await generatePDFReport(jsonReport)
  
  // 3. 保存JSON文件到云存储
  const jsonCloudPath = `reports/${reportType}/${OPENID}/${reportId}.json`
  const jsonUploadResult = await cloud.uploadFile({
    cloudPath: jsonCloudPath,
    fileContent: jsonBuffer
  })
  
  // 4. 保存PDF文件到云存储
  const pdfCloudPath = `reports/${reportType}/${OPENID}/${reportId}.pdf`
  const pdfUploadResult = await cloud.uploadFile({
    cloudPath: pdfCloudPath,
    fileContent: pdfBuffer
  })
  
  return {
    jsonUrl: jsonUploadResult.fileID,
    pdfUrl: pdfUploadResult.fileID,
    jsonFileSize: jsonBuffer.length,
    pdfFileSize: pdfBuffer.length
  }
}
```

### 7.3 getReportDetail 云函数
```javascript
// 获取报告详情和下载链接
exports.main = async (event, context) => {
  const { reportId } = event
  const { OPENID } = cloud.getWXContext()
  
  try {
    const report = await db.collection('reports')
      .doc(reportId)
      .get()
    
    if (!report.data || report.data.userId !== OPENID) {
      throw new Error('报告不存在或无权限访问')
    }
    
    const reportData = report.data
    
    // 检查报告是否已过期
    if (reportData.metadata.expiresAt && new Date() > new Date(reportData.metadata.expiresAt)) {
      throw new Error('报告已过期')
    }
    
    // 生成临时下载链接
    const tempUrls = await generateTempDownloadUrls(reportData.output.reportFiles)
    
    return {
      success: true,
      data: {
        reportInfo: {
          id: reportData._id,
          type: reportData.reportType,
          title: reportData.output.summary.reportTitle,
          generateTime: reportData.output.summary.generateTime,
          status: reportData.processing.status
        },
        downloadUrls: tempUrls,
        summary: reportData.output.summary,
        fileInfo: reportData.output.fileInfo
      }
    }
  } catch (error) {
    console.error('获取报告详情失败:', error)
    throw error
  }
}

// 生成临时下载链接
async function generateTempDownloadUrls(reportFiles) {
  const tempUrls = {}
  
  if (reportFiles.jsonUrl) {
    const jsonResult = await cloud.getTempFileURL({
      fileList: [reportFiles.jsonUrl],
      maxAge: 3600  // 1小时有效期
    })
    tempUrls.jsonUrl = jsonResult.fileList[0].tempFileURL
  }
  
  if (reportFiles.pdfUrl) {
    const pdfResult = await cloud.getTempFileURL({
      fileList: [reportFiles.pdfUrl],
      maxAge: 3600  // 1小时有效期
    })
    tempUrls.pdfUrl = pdfResult.fileList[0].tempFileURL
  }
  
  return tempUrls
}
```

### 7.4 downloadReport 云函数
```javascript
// 报告下载统计
exports.main = async (event, context) => {
  const { reportId, fileType } = event  // fileType: 'json' | 'pdf'
  const { OPENID } = cloud.getWXContext()
  
  try {
    // 验证权限
    const report = await db.collection('reports')
      .doc(reportId)
      .get()
    
    if (!report.data || report.data.userId !== OPENID) {
      throw new Error('报告不存在或无权限访问')
    }
    
    // 更新下载统计
    await db.collection('reports').doc(reportId).update({
      data: {
        'output.fileInfo.downloadCount': db.command.inc(1),
        'output.fileInfo.lastDownloadTime': new Date()
      }
    })
    
    // 生成下载链接
    const fileUrl = fileType === 'pdf' 
      ? report.data.output.reportFiles.pdfUrl 
      : report.data.output.reportFiles.jsonUrl
    
    const tempUrlResult = await cloud.getTempFileURL({
      fileList: [fileUrl],
      maxAge: 300  // 5分钟有效期
    })
    
    return {
      success: true,
      downloadUrl: tempUrlResult.fileList[0].tempFileURL,
      fileName: `${report.data.output.summary.reportTitle}.${fileType}`
    }
  } catch (error) {
    console.error('生成下载链接失败:', error)
    throw error
  }
}
```

## 8. 前端交互更新

### 8.1 报告详情页面
```javascript
// 报告详情页面逻辑
Page({
  data: {
    reportId: '',
    reportInfo: null,
    downloadUrls: null,
    loading: true,
    downloading: false
  },

  async onLoad(options) {
    this.setData({ reportId: options.reportId })
    await this.loadReportDetail()
  },

  // 加载报告详情
  async loadReportDetail() {
    try {
      const result = await wx.cloud.callFunction({
        name: 'getReportDetail',
        data: { reportId: this.data.reportId }
      })
      
      if (result.result.success) {
        this.setData({
          reportInfo: result.result.data.reportInfo,
          downloadUrls: result.result.data.downloadUrls,
          summary: result.result.data.summary,
          loading: false
        })
      }
    } catch (error) {
      console.error('加载报告失败:', error)
      showError('加载报告失败')
      this.setData({ loading: false })
    }
  },

  // 下载报告
  async onDownloadReport(event) {
    const fileType = event.currentTarget.dataset.type  // 'json' | 'pdf'
    
    if (this.data.downloading) return
    this.setData({ downloading: true })
    
    try {
      const result = await wx.cloud.callFunction({
        name: 'downloadReport',
        data: {
          reportId: this.data.reportId,
          fileType: fileType
        }
      })
      
      if (result.result.success) {
        // 下载文件
        wx.downloadFile({
          url: result.result.downloadUrl,
          success: (res) => {
            if (res.statusCode === 200) {
              // 保存到相册或分享
              if (fileType === 'pdf') {
                wx.saveFile({
                  tempFilePath: res.tempFilePath,
                  success: () => {
                    showSuccess('PDF报告已保存')
                  }
                })
              } else {
                showSuccess('JSON报告下载完成')
              }
            }
          },
          fail: () => {
            showError('下载失败')
          }
        })
      }
    } catch (error) {
      console.error('下载失败:', error)
      showError('下载失败')
    } finally {
      this.setData({ downloading: false })
    }
  },

  // 在线预览报告
  async onPreviewReport() {
    const { downloadUrls } = this.data
    
    if (downloadUrls && downloadUrls.pdfUrl) {
      wx.openDocument({
        filePath: downloadUrls.pdfUrl,
        fileType: 'pdf',
        success: () => {
          console.log('打开文档成功')
        },
        fail: (error) => {
          console.error('打开文档失败:', error)
          showError('预览失败')
        }
      })
    }
  }
})
```

### 8.2 报告列表页面
```javascript
// 历史报告列表
async loadReportList() {
  try {
    const result = await wx.cloud.callFunction({
      name: 'getReportList',
      data: { 
        page: this.data.currentPage,
        pageSize: 10
      }
    })
    
    if (result.result.success) {
      const reports = result.result.data.reports.map(report => ({
        id: report._id,
        title: report.output.summary.reportTitle,
        type: report.reportType,
        date: report.output.summary.generateTime,
        status: report.processing.status,
        score: report.output.summary.analysisScore,
        downloadCount: report.output.fileInfo.downloadCount
      }))
      
      this.setData({
        reportList: [...this.data.reportList, ...reports],
        hasMore: result.result.data.hasMore
      })
    }
  } catch (error) {
    console.error('加载报告列表失败:', error)
    showError('加载失败')
  }
}
